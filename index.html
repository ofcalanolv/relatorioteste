<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Cadastro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBF1yHRhTo_7UCmSQOldzMj-l_BFx0Upyw",
        authDomain: "alan-3af8e.firebaseapp.com",
        projectId: "alan-3af8e",
        storageBucket: "alan-3af8e.firebasestorage.app",
        messagingSenderId: "533983566282",
        appId: "1:533983566282:web:04ca67fa8fc63566605733"
      };
      
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      const auth = firebase.auth();
    </script>
    
    <style>
        /* Variáveis CSS para cores */
        :root {
            --primary-color: #007bff; /* Azul para destaque/ações */
            --primary-dark: #0056b3;
            --secondary-color: #6c757d; /* Cinza para texto secundário */
            --bg-light: #f8f9fa; /* Fundo claro */
            --bg-medium: #e9ecef; /* Fundo de elementos */
            --text-dark: #343a40; /* Texto principal */
            --text-light: #ffffff; /* Texto claro */
            --border-color: #dee2e6; /* Cor de borda */
            --red-color: #dc3545; /* Vermelho para alerta/erro */
            --green-color: #28a745; /* Verde para sucesso */
            --whatsapp-green: #25d366; /* Verde WhatsApp */
            --whatsapp-green-dark: #1da851;
            --yellow-color: #ffc107; /* Amarelo para aviso */
            --yellow-dark: #e0a800;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; /* Fonte mais profissional */
            margin: 0;
            background: var(--bg-light);
            padding-bottom: 70px; /* Padding para a taskbar fixa */
            color: var(--text-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased; /* Suavização de fonte */
            -moz-osx-font-smoothing: grayscale; /* Suavização de fonte */
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 15px; /* Restaura a margem superior */
            margin-bottom: 5px; /* Espaçamento menor para o código */
            font-size: 2em;
            font-weight: 600;
        }

        h3 {
            text-align: left; /* Alinhamento para títulos de grupo */
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .container {
            max-width: 600px; /* Um pouco mais largo para melhor espaçamento */
            margin: 20px auto;
            background: var(--text-light);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Sombra mais suave */
            margin-bottom: 30px;
        }

        input,
        select,
        textarea {
            display: block;
            margin: 15px 0; /* Mais espaçamento vertical */
            padding: 12px 15px;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Bordas mais arredondadas */
            font-size: 1em;
            color: var(--text-dark);
            background-color: var(--bg-light);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); /* Sombra no foco */
            outline: none;
        }

        input:disabled, select:disabled, textarea:disabled {
            background-color: var(--bg-medium);
            color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.9;
        }

        .inline-fields {
            display: flex;
            gap: 15px; /* Mais espaçamento entre campos */
        }
        .inline-fields input, .inline-fields select { /* Aplica estilo também para select */
            flex: 1;
        }

        #fotosPreview, #fotosDocumentoPreview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Espaçamento entre as miniaturas */
            margin-top: 20px;
            padding: 5px;
            border: 1px dashed var(--border-color); /* Borda discreta para a área de preview */
            border-radius: 8px;
            min-height: 90px; /* Altura mínima para mostrar a área */
            justify-content: center; /* Centraliza as miniaturas */
            align-items: center;
        }

        .foto-container {
            position: relative;
            display: inline-block;
            border-radius: 8px;
            overflow: hidden; /* Garante que a imagem respeite o border-radius */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .foto-thumb {
            width: 90px; /* Um pouco maior */
            height: 90px; /* Um pouco maior */
            object-fit: cover;
            display: block; /* Remove espaço extra abaixo da imagem */
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--red-color);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            font-size: 0.8em;
            width: 24px; /* Maior para melhor toque */
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            transition: background 0.2s, opacity 0.2s;
        }
        .remove-btn:hover {
            background: #c82333;
            opacity: 1;
        }

        #gps, #gpsTecnico { /* Aplica estilo ao GPS de ambas as abas */
            font-size: 0.9em;
            color: var(--secondary-color);
            text-align: center;
            margin-top: 10px;
        }

        #contador, #contadorTecnico, #contadorRelatorioEncaminhamento { /* Aplica estilo aos contadores */
            font-size: 0.85em;
            text-align: right;
            color: var(--secondary-color);
            margin-top: -10px; /* Ajuste para ficar mais próximo da textarea */
            margin-bottom: 10px;
        }

        #codigoDisplay, #codigoDisplayTecnico {
            font-size: 0.85em; /* Tamanho menor */
            font-weight: 500;
            text-align: center;
            margin-top: 5px; /* Ajuste para ficar abaixo do h2 */
            margin-bottom: 20px;
            color: var(--secondary-color);
            padding: 4px 8px; /* Padding menor */
            background: var(--bg-medium);
            border-radius: 6px;
            display: inline-block; /* Para centralizar com text-align no pai */
            width: auto;
            max-width: 80%;
            box-sizing: border-box;
        }

        /* Removido o estilo para #mapPreview, pois o elemento será removido */

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Para botões em duas linhas em telas pequenas */
        }

        .camera-controls button {
            flex: 1;
            margin: 0;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            color: var(--text-light);
        }
        .camera-controls button#captureBtn { background: var(--primary-color); }
        .camera-controls button#captureBtn:hover { background: var(--primary-dark); }
        .camera-controls button#stopCameraBtn { background: var(--red-color); }
        .camera-controls button#stopCameraBtn:hover { background: #c82333; }
        
        /* #cameraMessage foi removido do HTML e do CSS */

        /* Taskbar Styles */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--text-light); /* Fundo claro para a taskbar */
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0; /* Padding ajustado */
            box-shadow: 0 -4px 15px rgba(0,0,0,0.08); /* Sombra suave para cima */
            z-index: 1000;
        }

        .taskbar button {
            background: none;
            border: none;
            color: var(--secondary-color); /* Cor dos ícones/texto */
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
            flex: 1;
            margin: 0 4px;
        }

        .taskbar button:not(:disabled):hover {
            background: var(--bg-medium);
            color: var(--primary-color);
        }

        .taskbar button i {
            font-size: 1.6em; /* Tamanho dos ícones */
            margin-bottom: 3px;
        }

        .taskbar button span {
            font-size: 0.75em; /* Tamanho do label */
            white-space: nowrap;
        }

        /* Cores específicas dos botões da taskbar */
        .taskbar button#btnColetarGPS { color: var(--primary-color); }
        .taskbar button#btnTirarFoto { color: var(--green-color); }
        .taskbar button#btnGerarPDF { color: var(--yellow-dark); } /* Amarelo mais escuro para melhor contraste */
        .taskbar button#btnLimparFormulario { color: var(--red-color); }
        .taskbar button#btnEnviarWhatsApp { color: var(--whatsapp-green); }
        .taskbar button#logoutBtn { color: var(--secondary-color); }

        /* Estado desabilitado para botões da taskbar */
        .taskbar button:disabled {
            color: var(--border-color); /* Cor mais clara para desabilitado */
            cursor: not-allowed;
            opacity: 0.6;
        }


        @media (max-width: 768px) {
            .container {
                margin: 15px auto;
                padding: 20px;
                border-radius: 0; /* Remover borda em telas pequenas para parecer mais integrado */
                box-shadow: none;
            }
            .inline-fields { flex-direction: column; gap: 0; }
            .inline-fields input, .inline-fields select { margin-bottom: 10px; } /* Ajuste para select */

            .camera-controls { flex-direction: column; gap: 8px; }

            .taskbar {
                padding: 5px 0;
            }
            .taskbar button {
                padding: 5px 5px;
                gap: 2px;
            }
            .taskbar button i {
                font-size: 1.4em;
            }
            .taskbar button span {
                font-size: 0.7em;
            }
        }

        /* Checkbox demands styling */
        .demand-group {
            margin-top: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            background: var(--bg-light);
        }

        .demand-items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 25px; /* Espaçamento horizontal e vertical */
            justify-content: flex-start;
        }
        .demand-item {
            display: flex;
            align-items: center;
        }
        .demand-item input[type="checkbox"] {
            width: auto;
            margin: 0; /* Remove margem padrão */
            margin-right: 10px; /* Espaçamento entre checkbox e label */
            transform: scale(1.1); /* Um pouco maior */
            accent-color: var(--primary-color); /* Cor do checkbox quando marcado */
        }
        .demand-item label {
            font-size: 0.95em;
            cursor: pointer;
            color: var(--text-dark);
        }
        #outrosDemandaContainer, #outrosDemandaContainerTecnico {
            margin-top: 20px;
            width: 100%;
        }
        #outrosDemandaInput, #outrosDemandaInputTecnico {
            margin-top: 5px;
            width: calc(100% - 30px); /* Ajusta para padding do input */
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            justify-content: center;
            background: var(--bg-medium);
            padding: 0;
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky; /* Fixa as abas no topo */
            top: 0;
            z-index: 100; /* Garante que fique acima de outros elementos */
        }
        .tab-button {
            flex: 1;
            padding: 18px 25px; /* Mais padding para maior área de clique */
            cursor: pointer;
            border: none;
            background: var(--bg-medium);
            font-size: 1.1em;
            color: var(--secondary-color);
            transition: background 0.3s, color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
            text-align: center;
            font-weight: 600;
        }
        .tab-button:hover {
            background: var(--bg-light);
            color: var(--text-dark);
        }
        .tab-button.active {
            background: var(--text-light);
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05); /* Sombra suave para a aba ativa */
        }
        .tab-content {
            display: none;
            padding-top: 15px; /* Espaçamento entre a aba e o conteúdo */
        }
        .tab-content.active {
            display: block;
        }

        /* Campo de seleção (dropdown) */
        select {
            appearance: none; /* Remove estilo padrão do navegador */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23343a40" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            padding-right: 40px; /* Espaço para o ícone */
        }
        select option, select optgroup {
            background-color: var(--bg-light); /* Cor de fundo das opções */
            color: var(--text-dark);
        }
        select option:hover, select option:focus {
            background-color: var(--primary-color); /* Cor de fundo da opção em foco/hover */
            color: var(--text-light);
        }
        select option:disabled {
            color: var(--secondary-color); /* Cor para opções desabilitadas */
        }
        select option:first-child {
            color: var(--secondary-color); /* Cor para o placeholder */
        }
        /* Estilos adicionados para a tela de autenticação */
        .auth-container {
            max-width: 400px;
            margin-top: 50px;
            padding: 30px;
            background: var(--text-light);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .auth-button {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            margin-top: 15px;
            width: 100%;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .auth-button:hover {
            background: var(--primary-dark);
        }

        .auth-switch {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="authScreen" style="display: block;">
        <div class="container auth-container">
            <h2>Bem-vindo!</h2>
            <div id="authMessage" style="color: red; text-align: center; margin-bottom: 15px;"></div>

            <div id="loginForm">
                <h3>Entrar</h3>
                <input type="email" id="loginEmail" placeholder="E-mail" required>
                <input type="password" id="loginPassword" placeholder="Senha" required>
                <button id="loginBtn" class="auth-button">Entrar</button>
                <p class="auth-switch">Não tem uma conta? <a href="#" onclick="showRegisterForm()">Registre-se</a></p>
                <p class="auth-switch"><a href="#" onclick="showResetPassword()">Esqueceu a senha?</a></p>
            </div>

            <div id="registerForm" style="display: none;">
                <h3>Registrar</h3>
                <input type="text" id="registerName" placeholder="Nome completo" required>
                <input type="tel" id="registerPhone" placeholder="Telefone" required>
                <input type="email" id="registerEmail" placeholder="E-mail" required>
                <input type="password" id="registerPassword" placeholder="Senha" required>
                <input type="password" id="confirmPassword" placeholder="Confirmar Senha" required>
                <button id="registerBtn" class="auth-button">Registrar</button>
                <p class="auth-switch">Já tem uma conta? <a href="#" onclick="showLoginForm()">Entrar</a></p>
            </div>

            <div id="resetPasswordForm" style="display: none;">
                <h3>Redefinir Senha</h3>
                <input type="email" id="resetEmail" placeholder="E-mail para redefinição" required>
                <button id="resetPasswordBtn" class="auth-button">Redefinir Senha</button>
                <p class="auth-switch"><a href="#" onclick="showLoginForm()">Voltar para Login</a></p>
            </div>
        </div>
    </div>
    
    <div id="mainAppContent" style="display: none;">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('agenteCampo')">Agente de Campo</button>
            <button class="tab-button" onclick="showTab('tecnico')">Técnico</button>
        </div>

        <div id="agenteCampo" class="tab-content active">
            <div class="container" id="appContainerAgente">
                <h2>Cadastro de Usuário</h2>
                <div id="codigoDisplay"></div>
                <input type="text" id="nomeAgente" placeholder="Nome do Agente Responsável" disabled>
                <input type="tel" id="telefoneAgente" placeholder="Telefone do Agente Responsável" inputmode="numeric" pattern="[0-9]*" disabled>

                <input type="text" id="nome" placeholder="Nome do Usuário">
                <input type="text" id="identidade" placeholder="Identidade">
                <input type="tel" id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'agente')">

                <input type="text" id="endereco" placeholder="Endereço (coletado automaticamente)" readonly>
                <div class="inline-fields">
                    <input type="text" id="numero" placeholder="Número" oninput="atualizarEnderecoCompleto()">
                    <input type="text" id="complemento" placeholder="Complemento" oninput="atualizarEnderecoCompleto()">
                </div>
                <input type="tel" id="dataNascimento" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'agente')" onchange="calcularIdade('agente')">
                <input type="text" id="idade" placeholder="Idade" readonly>

                <textarea id="historico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador()"></textarea>
                <div id="contador">0 / 5000</div>

                <div class="demand-group">
                    <h3>Demandas:</h3>
                    <div class="demand-items-container"> 
                        <div class="demand-item">
                            <input type="checkbox" id="demandaBanho" name="demandas" value="Banho">
                            <label for="demandaBanho">Banho</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaAssistenteSocial" name="demandas" value="Assistente Social">
                            <label for="demandaAssistenteSocial">Assistente Social</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaPsicologo" name="demandas" value="Psicólogo">
                            <label for="demandaPsicologo">Psicólogo</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaEncaminhamento" name="demandas" value="Encaminhamento">
                            <label for="demandaEncaminhamento">Encaminhamento</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaAcolhimento" name="demandas" value="Acolhimento">
                            <label for="demandaAcolhimento">Acolhimento</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaDuvidas" name="demandas" value="Dúvidas">
                            <label for="demandaDuvidas">Dúvidas</label> 
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaInformacoes" name="demandas" value="Informações">
                            <label for="demandaInformacoes">Informações</label> 
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaCorteCabelo" name="demandas" value="Corte de cabelo">
                            <label for="demandaCabelo">Corte de cabelo</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaOutros" name="demandas" value="Outros">
                            <label for="demandaOutros">Outros</label>
                        </div>
                    </div> 
                    <div id="outrosDemandaContainer" style="display:none;">
                        <input type="text" id="outrosDemandaInput" placeholder="Especifique outras demandas">
                    </div>
                </div>

                <video id="video" width="100%" autoplay style="display:none;" playsinline></video>
                <div class="camera-controls">
                    <button id="captureBtn" style="display:none;" onclick="capturarImagem('agente')">Capturar Imagem</button>
                    <button id="stopCameraBtn" style="display:none;" onclick="pararCamera('agente')">Fechar Câmera</button>
                </div>
                <div id="fotosPreview"></div>
                <p id="gps"></p>
            </div>
        </div>

        <div id="tecnico" class="tab-content">
            <div class="container" id="appContainerTecnico">
                <h2>Cadastro de Usuário</h2>
                <div id="codigoDisplayTecnico"></div>
                <input type="text" id="nomeTecnico" placeholder="Nome do Técnico Responsável" disabled>
                <input type="tel" id="telefoneTecnico" placeholder="Telefone do Técnico Responsável" inputmode="numeric" pattern="[0-9]*" disabled>

                <input type="text" id="nome_tecnico" placeholder="Nome do Usuário">
                <input type="text" id="identidade_tecnico" placeholder="Identidade">
                <input type="tel" id="cpf_tecnico" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'tecnico')">

                <input type="text" id="endereco_tecnico" placeholder="Endereço (coletado automaticamente)" readonly>
                <div class="inline-fields">
                    <input type="text" id="numero_tecnico" placeholder="Número" oninput="atualizarEnderecoCompleto('tecnico')">
                    <input type="text" id="complemento_tecnico" placeholder="Complemento" oninput="atualizarEnderecoCompleto('tecnico')">
                </div>
                <input type="tel" id="dataNascimento_tecnico" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'tecnico')" onchange="calcularIdade('tecnico')">
                <input type="text" id="idade_tecnico" placeholder="Idade" readonly>

                <select id="cadUnico_tecnico" required>
                    <option value="">Possui CAD Único?</option>
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>

                <select id="bolsaFamilia_tecnico" required>
                    <option value="">Possui Bolsa-Família?</option>
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>

                <select id="centroRecuperacao_tecnico" required>
                    <option value="">Já passou por centro de recuperação?</option>
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>

                <textarea id="historico_tecnico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador('tecnico')"></textarea>
                <div id="contadorTecnico">0 / 5000</div>

                <textarea id="relatorioEncaminhamento_tecnico" placeholder="Relatório de Encaminhamento (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador('relatorioEncaminhamento')"></textarea>
                <div id="contadorRelatorioEncaminhamento">0 / 5000</div>

                <div class="demand-group">
                    <h3>Demandas:</h3>
                    <div class="demand-items-container"> 
                        <div class="demand-item">
                            <input type="checkbox" id="demandaBanho_tecnico" name="demandas_tecnico" value="Banho" onchange="checkDemandasTecnico()">
                            <label for="demandaBanho_tecnico">Banho</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaAssistenteSocial_tecnico" name="demandas_tecnico" value="Assistente Social" onchange="checkDemandasTecnico()">
                            <label for="demandaAssistenteSocial_tecnico">Assistente Social</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaPsicologo_tecnico" name="demandas_tecnico" value="Psicólogo" onchange="checkDemandasTecnico()">
                            <label for="demandaPsicologo_tecnico">Psicólogo</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaEncaminhamento_tecnico" name="demandas_tecnico" value="Encaminhamento" onchange="checkDemandasTecnico()">
                            <label for="demandaEncaminhamento_tecnico">Encaminhamento</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaAcolhimento_tecnico" name="demandas_tecnico" value="Acolhimento" onchange="checkDemandasTecnico()">
                            <label for="demandaAcolhimento_tecnico">Acolhimento</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaDuvidas_tecnico" name="demandas_tecnico" value="Dúvidas" onchange="checkDemandasTecnico()">
                            <label for="demandaDuvidas_tecnico">Dúvidas</label> 
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaInformacoes_tecnico" name="demandas_tecnico" value="Informações" onchange="checkDemandasTecnico()">
                            <label for="demandaInformacoes_tecnico">Informações</label> 
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaCorteCabelo_tecnico" name="demandas_tecnico" value="Corte de cabelo" onchange="checkDemandasTecnico()">
                            <label for="demandaCabelo_tecnico">Corte de cabelo</label>
                        </div>
                        <div class="demand-item">
                            <input type="checkbox" id="demandaOutros_tecnico" name="demandas_tecnico" value="Outros" onchange="checkDemandasTecnico()">
                            <label for="demandaOutros_tecnico">Outros</label>
                        </div>
                    </div> 
                    <div id="outrosDemandaContainerTecnico" style="display:none;">
                        <input type="text" id="outrosDemandaInputTecnico" placeholder="Especifique outras demandas">
                    </div>
                </div>

                <div class="demand-item" style="margin-top: 20px;">
                    <input type="checkbox" id="atendimentoPsicossocial_tecnico" name="atendimentoPsicossocial_tecnico">
                    <label for="atendimentoPsicossocial_tecnico">Atendimento Psicossocial</label>
                </div>

                <div id="fotosPreviewTecnico"></div>
                <p id="gpsTecnico"></p>
            </div>
        </div>
    </div>

    <div class="taskbar" id="mainTaskbar">
        <button id="btnColetarGPS" onclick="coletarGPS()">
            <i class="fas fa-map-marker-alt"></i>
            <span>Endereço</span>
        </button>
        <button id="btnTirarFoto" onclick="tirarFoto('global')">
            <i class="fas fa-camera"></i>
            <span>Foto</span>
        </button>
        <button id="btnGerarPDF" onclick="gerarPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>Gerar PDF</span>
        </button>
        <button id="btnLimparFormulario" onclick="limparFormulario()">
            <i class="fas fa-broom"></i>
            <span>Limpar</span>
        </button>
        <button id="btnEnviarWhatsApp" onclick="enviarWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
        </button>
        <button id="logoutBtn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sair</span>
        </button>
    </div>

    <script>
        // Dados para Agente de Campo
        let dadosAgenteCampo = {
            fotos: [], // Fotos do usuário
            coordenadas: "",
            enderecoBaseDetalhes: {}, // Mantido para o endereço textual
            codigoAtual: "",
            mapImageUrl: "", // Não será mais usado, mas mantido para evitar erros em outras partes
            pdfDataUri: null,
            pdfFileName: "",
            agenteDadosPreenchidos: false, // Adicione mais campos aqui se precisar de dados separados para cada aba
            nomeAgente: "",
            telefoneAgente: "",
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            historico: "",
            demandas: []
        };

        // Dados para Técnico (inicialmente duplicados para teste)
        let dadosTecnico = {
            fotos: [],
            coordenadas: "",
            enderecoBaseDetalhes: {}, // Mantido para o endereço textual
            codigoAtual: "",
            mapImageUrl: "", // Não será mais usado, mas mantido para evitar erros em outras partes
            pdfDataUri: null,
            pdfFileName: "",
            agenteDadosPreenchidos: false, // Pode ser renomeado para 'tecnicoDadosPreenchidos'
            // IDs de campos da aba Técnico devem ser atualizados para pegar seus próprios valores
            nomeAgente: "", // Isso será nomeTecnico
            telefoneAgente: "", // Isso será telefoneTecnico
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            cadUnico: "",
            bolsaFamilia: "",
            centroRecuperacao: "",
            historico: "",
            relatorioEncaminhamento: "", // NOVO CAMPO
            demandas: [],
            atendimentoPsicossocial: false // NOVO CAMPO
        };

        let activeTab = 'agenteCampo'; // Controla qual aba está ativa
        let cameraStream = null; // Stream da câmera principal

        const addCustomFont = (doc) => {
            doc.addFont('helvetica', 'normal', 'normal');
        };

        function getActiveData() {
            return activeTab === 'agenteCampo' ? dadosAgenteCampo : dadosTecnico;
        }

        function getElementByIdForActiveTab(idBase, forElement = true) {
            if (activeTab === 'agenteCampo') {
                return document.getElementById(idBase);
            } else {
                // IDs para aba técnico
                if (idBase === 'codigoDisplay') return document.getElementById('codigoDisplayTecnico');
                if (idBase === 'nomeAgente') return document.getElementById('nomeTecnico');
                if (idBase === 'telefoneAgente') return document.getElementById('telefoneTecnico');
                if (idBase === 'nome') return document.getElementById('nome_tecnico');
                if (idBase === 'identidade') return document.getElementById('identidade_tecnico');
                if (idBase === 'cpf') return document.getElementById('cpf_tecnico');
                if (idBase === 'endereco') return document.getElementById('endereco_tecnico');
                if (idBase === 'numero') return document.getElementById('numero_tecnico');
                if (idBase === 'complemento') return document.getElementById('complemento_tecnico');
                if (idBase === 'dataNascimento') return document.getElementById('dataNascimento_tecnico');
                if (idBase === 'idade') return document.getElementById('idade_tecnico');
                if (idBase === 'historico') return document.getElementById('historico_tecnico');
                if (idBase === 'contador') return document.getElementById('contadorTecnico');
                if (idBase === 'demandaOutros') return document.getElementById('demandaOutros_tecnico');
                if (idBase === 'outrosDemandaContainer') return document.getElementById('outrosDemandaContainerTecnico');
                if (idBase === 'outrosDemandaInput') return document.getElementById('outrosDemandaInputTecnico');
                if (idBase === 'fotosPreview') return document.getElementById('fotosPreviewTecnico');
                if (idBase === 'gps') return document.getElementById('gpsTecnico');
                // Novos campos da aba técnico
                if (idBase === 'cadUnico') return document.getElementById('cadUnico_tecnico');
                if (idBase === 'bolsaFamilia') return document.getElementById('bolsaFamilia_tecnico');
                if (idBase === 'centroRecuperacao') return document.getElementById('centroRecuperacao_tecnico');
                if (idBase === 'relatorioEncaminhamento') return document.getElementById('relatorioEncaminhamento_tecnico');
                // NOVO
                if (idBase === 'contadorRelatorioEncaminhamento') return document.getElementById('contadorRelatorioEncaminhamento'); // NOVO
                if (idBase === 'atendimentoPsicossocial') return document.getElementById('atendimentoPsicossocial_tecnico'); // NOVO
                // Campos de camera são compartilhados no HTML
                if (idBase === 'video' || idBase === 'captureBtn' || idBase === 'stopCameraBtn') {
                    return document.getElementById(idBase);
                }
                // Para checkboxes, o 'name' é diferente
                if (idBase === 'demandas') {
                    return document.querySelectorAll(`input[name="demandas_tecnico"]`);
                } else if (forElement) {
                    // Default para outros elementos
                    return document.getElementById(`${idBase}_tecnico`);
                }
                return null;
            }
        }

        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            activeTab = tabId; // Atualiza a aba ativa

            // Re-renderizar o código de atendimento e habilitar/desabilitar o botão do WhatsApp
            const activeData = getActiveData();
            gerarCodigoAtendimento(); // Gera um novo código para a aba ativa (ou exibe o existente)
            document.getElementById('btnEnviarWhatsApp').disabled = !activeData.pdfDataUri;

            // Para parar a câmera se o usuário mudar de aba com a câmera aberta
            pararCamera('global');
        }

        function gerarCodigoAtendimento() {
            const activeData = getActiveData();
            if (!activeData.codigoAtual) {
                const agora = new Date();
                const d = String(agora.getDate()).padStart(2, '0');
                const m = String(agora.getMonth() + 1).padStart(2, '0');
                const y = agora.getFullYear();
                const h = String(agora.getHours()).padStart(2, '0');
                const min = String(agora.getMinutes()).padStart(2, '0');
                const s = String(agora.getSeconds()).padStart(2, '0');
                activeData.codigoAtual = `${d}${m}${y}-${h}${min}${s}`;
            }
            getElementByIdForActiveTab('codigoDisplay').innerText = `Relatório nº: ${activeData.codigoAtual}`;
        }

        // Função para formatar o CPF (agente e técnico)
        function formatarCPF(campo, tipo) {
            let cpf = campo.value.replace(/\D/g, '');
            if (cpf.length > 11) {
                cpf = cpf.slice(0, 11);
            }
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            campo.value = cpf;
        }

        // Função para formatar a data de nascimento (agente e técnico)
        function formatarDataNascimento(campo, tipo) {
            let data = campo.value.replace(/\D/g, '');
            if (data.length > 8) {
                data = data.slice(0, 8);
            }
            data = data.replace(/(\d{2})(\d)/, '$1/$2');
            data = data.replace(/(\d{2})(\d)/, '$1/$2');
            campo.value = data;
        }

        // Função para calcular a idade (agente e técnico)
        function calcularIdade(tipo) {
            const campoDataNascimento = getElementByIdForActiveTab('dataNascimento');
            const campoIdade = getElementByIdForActiveTab('idade');
            const dataNascimento = campoDataNascimento.value;
            const partesData = dataNascimento.split('/');
            if (partesData.length === 3) {
                const dia = parseInt(partesData[0], 10);
                const mes = parseInt(partesData[1], 10);
                const ano = parseInt(partesData[2], 10);
                
                const hoje = new Date();
                const anoAtual = hoje.getFullYear();
                const mesAtual = hoje.getMonth() + 1;
                const diaAtual = hoje.getDate();
                
                let idade = anoAtual - ano;
                
                if (mesAtual < mes || (mesAtual === mes && diaAtual < dia)) {
                    idade--;
                }
                campoIdade.value = idade;
            } else {
                campoIdade.value = "";
            }
        }

        // NOVO: Função para atualizar o endereço completo
        function atualizarEnderecoCompleto() {
            const activeData = getActiveData();
            const campoEndereco = getElementByIdForActiveTab('endereco');
            const campoNumero = getElementByIdForActiveTab('numero');
            const campoComplemento = getElementByIdForActiveTab('complemento');

            let enderecoCompleto = "";
            
            if (activeData.enderecoBaseDetalhes.road) {
                enderecoCompleto += activeData.enderecoBaseDetalhes.road;
            }

            if (campoNumero.value) {
                enderecoCompleto += `, ${campoNumero.value}`;
            }

            if (activeData.enderecoBaseDetalhes.suburb) {
                enderecoCompleto += `, ${activeData.enderecoBaseDetalhes.suburb}`;
            }

            if (campoComplemento.value) {
                enderecoCompleto += `, ${campoComplemento.value}`;
            }
            
            if (activeData.enderecoBaseDetalhes.city || activeData.enderecoBaseDetalhes.state) {
                const cidadeEstado = [];
                if (activeData.enderecoBaseDetalhes.city) cidadeEstado.push(activeData.enderecoBaseDetalhes.city);
                if (activeData.enderecoBaseDetalhes.state) cidadeEstado.push(activeData.enderecoBaseDetalhes.state);
                enderecoCompleto += ` - ${cidadeEstado.join('/')}`;
            }

            campoEndereco.value = enderecoCompleto.trim();
        }

        // Função para capturar a localização (agente e técnico)
        async function coletarGPS() {
            const gpsElement = getElementByIdForActiveTab('gps');
            const btn = document.getElementById('btnColetarGPS');
            btn.disabled = true;
            gpsElement.innerText = "Coletando localização...";
            
            if ("geolocation" in navigator) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'User-Agent': 'CadastroApp/1.0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Falha na geocodificação reversa');
                    }
                    
                    const data = await response.json();
                    
                    const enderecoBase = data.address || {};
                    gpsElement.innerText = `GPS: Latitude ${latitude.toFixed(6)}, Longitude ${longitude.toFixed(6)}`;
                    
                    const activeData = getActiveData();
                    activeData.coordenadas = `Latitude ${latitude}, Longitude ${longitude}`;
                    activeData.enderecoBaseDetalhes = enderecoBase;

                    const campoEndereco = getElementByIdForActiveTab('endereco');
                    let enderecoTexto = "";
                    if (enderecoBase.road) enderecoTexto += enderecoBase.road;
                    if (enderecoBase.suburb) enderecoTexto += `, ${enderecoBase.suburb}`;
                    if (enderecoBase.city) enderecoTexto += `, ${enderecoBase.city}`;
                    if (enderecoBase.state) enderecoTexto += `/${enderecoBase.state}`;
                    campoEndereco.value = enderecoTexto.trim();

                    atualizarEnderecoCompleto(); // Atualiza o endereço completo com os dados coletados
                } catch (error) {
                    gpsElement.innerText = `Erro: ${error.message}. Tente novamente.`;
                    console.error("Erro na coleta de GPS:", error);
                } finally {
                    btn.disabled = false;
                }
            } else {
                gpsElement.innerText = "Geolocalização não é suportada por este navegador.";
                btn.disabled = false;
            }
        }
        
        // Função para iniciar a câmera (agente e técnico)
        async function tirarFoto(tipo) {
            const videoElement = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            const previewElement = getElementByIdForActiveTab('fotosPreview');
            
            if (cameraStream) {
                pararCamera(tipo);
            }
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment" // Usa a câmera traseira em dispositivos móveis
                    },
                    audio: false
                });
                videoElement.srcObject = cameraStream;
                videoElement.style.display = 'block';
                captureBtn.style.display = 'inline-block';
                stopCameraBtn.style.display = 'inline-block';
                previewElement.style.borderStyle = 'solid'; // Muda o estilo da borda ao iniciar a câmera
            } catch (error) {
                console.error("Erro ao acessar a câmera:", error);
                alert("Não foi possível acessar a câmera. Verifique as permissões.");
            }
        }
        
        // Função para parar a câmera (agente e técnico)
        function pararCamera(tipo) {
            const videoElement = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            const previewElement = getElementByIdForActiveTab('fotosPreview');
            
            if (cameraStream) {
                const tracks = cameraStream.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
                cameraStream = null;
                videoElement.style.display = 'none';
                captureBtn.style.display = 'none';
                stopCameraBtn.style.display = 'none';
                previewElement.style.borderStyle = 'dashed'; // Retorna o estilo da borda
            }
        }

        // Função para capturar a imagem (agente e técnico)
        function capturarImagem() {
            const videoElement = document.getElementById('video');
            const previewElement = getElementByIdForActiveTab('fotosPreview');
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            const activeData = getActiveData();
            activeData.fotos.push(imageDataUrl);
            
            const fotoContainer = document.createElement('div');
            fotoContainer.className = 'foto-container';
            
            const img = document.createElement('img');
            img.src = imageDataUrl;
            img.className = 'foto-thumb';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                const fotoIndex = activeData.fotos.indexOf(imageDataUrl);
                if (fotoIndex > -1) {
                    activeData.fotos.splice(fotoIndex, 1);
                    previewElement.removeChild(fotoContainer);
                }
            };
            
            fotoContainer.appendChild(img);
            fotoContainer.appendChild(removeBtn);
            previewElement.appendChild(fotoContainer);
        }

        // Função para verificar demandas (agente e técnico)
        function checkDemandas(tipo = 'agente') {
            const demandaOutros = getElementByIdForActiveTab('demandaOutros');
            const outrosContainer = getElementByIdForActiveTab('outrosDemandaContainer');
            
            if (demandaOutros.checked) {
                outrosContainer.style.display = 'block';
            } else {
                outrosContainer.style.display = 'none';
                getElementByIdForActiveTab('outrosDemandaInput').value = '';
            }
        }

        // Chamada específica para o técnico
        function checkDemandasTecnico() {
            checkDemandas('tecnico');
        }

        function atualizarContador(campoId = 'historico') {
            const campo = getElementByIdForActiveTab(campoId);
            const contador = getElementByIdForActiveTab('contador'); // Supondo que o contador tenha o mesmo ID
            const activeData = getActiveData();

            let maxChars;
            if (campoId === 'historico') {
                maxChars = 5000;
                contador.innerText = `${campo.value.length} / ${maxChars}`;
            } else if (campoId === 'relatorioEncaminhamento') {
                maxChars = 5000;
                const contadorRelatorio = getElementByIdForActiveTab('contadorRelatorioEncaminhamento');
                contadorRelatorio.innerText = `${campo.value.length} / ${maxChars}`;
            }
        }

        // Event listener para a checkbox "Outros"
        document.getElementById('demandaOutros').addEventListener('change', () => checkDemandas('agente'));
        document.getElementById('demandaOutros_tecnico').addEventListener('change', () => checkDemandas('tecnico'));
        
        // Função para limpar formulário
        function limparFormulario() {
            const activeData = getActiveData();
            const tabId = activeTab;

            const formElements = document.getElementById(tabId).querySelectorAll('input, textarea, select');
            formElements.forEach(element => {
                if (element.type === 'text' || element.type === 'tel' || element.type === 'textarea') {
                    if (element.id !== 'nomeAgente' && element.id !== 'telefoneAgente' && element.id !== 'nomeTecnico' && element.id !== 'telefoneTecnico') {
                        element.value = '';
                    }
                } else if (element.type === 'checkbox') {
                    element.checked = false;
                } else if (element.tagName === 'SELECT') {
                    element.selectedIndex = 0;
                }
            });

            // Limpa dados específicos da aba
            activeData.fotos = [];
            activeData.coordenadas = "";
            activeData.enderecoBaseDetalhes = {};
            activeData.codigoAtual = "";
            activeData.pdfDataUri = null;
            activeData.agenteDadosPreenchidos = false;

            // Limpa previews e contadores
            getElementByIdForActiveTab('fotosPreview').innerHTML = '';
            getElementByIdForActiveTab('gps').innerText = '';
            getElementByIdForActiveTab('contador').innerText = '0 / 5000';
            
            // Para a câmera se estiver ativa
            pararCamera('global');

            // Recarrega o código de atendimento para o próximo
            gerarCodigoAtendimento();
        }

        // Função para gerar PDF (agente e técnico)
        async function gerarPDF() {
            const activeData = getActiveData();
            const doc = new jspdf.jsPDF();

            addCustomFont(doc);
            doc.setFont('helvetica');

            doc.text(`Relatório de Atendimento Nº: ${activeData.codigoAtual}`, 20, 20);

            let yOffset = 30;

            const addText = (text, x, y) => {
                doc.text(text, x, y);
            };

            const addField = (label, value) => {
                addText(`${label}: ${value}`, 20, yOffset);
                yOffset += 10;
            };

            // Dados do Agente/Técnico
            if (activeTab === 'agenteCampo') {
                addField('Nome do Agente', getElementByIdForActiveTab('nomeAgente').value);
                addField('Telefone do Agente', getElementByIdForActiveTab('telefoneAgente').value);
            } else {
                addField('Nome do Técnico', getElementByIdForActiveTab('nomeAgente').value);
                addField('Telefone do Técnico', getElementByIdForActiveTab('telefoneAgente').value);
            }
            yOffset += 5;

            // Dados do Usuário
            addField('Nome do Usuário', getElementByIdForActiveTab('nome').value);
            addField('Identidade', getElementByIdForActiveTab('identidade').value);
            addField('CPF', getElementByIdForActiveTab('cpf').value);
            addField('Data de Nascimento', getElementByIdForActiveTab('dataNascimento').value);
            addField('Idade', getElementByIdForActiveTab('idade').value);
            yOffset += 5;
            
            // Endereço e GPS
            const endereco = getElementByIdForActiveTab('endereco').value;
            if (endereco) {
                addField('Endereço', endereco);
            } else {
                addField('Endereço', 'Não informado');
            }
            addField('Coordenadas GPS', activeData.coordenadas || 'Não informado');
            yOffset += 5;

            // Histórico
            doc.text('Histórico do Usuário:', 20, yOffset);
            yOffset += 5;
            const historico = getElementByIdForActiveTab('historico').value;
            const historicoLines = doc.splitTextToSize(historico, 170);
            doc.text(historicoLines, 20, yOffset);
            yOffset += (historicoLines.length * 7) + 5;
            yOffset = yOffset > 270 ? 20 : yOffset; // Quebra de página

            // Relatório de Encaminhamento (apenas para Técnico)
            if (activeTab === 'tecnico') {
                const relatorio = getElementByIdForActiveTab('relatorioEncaminhamento').value;
                if (relatorio) {
                    doc.addPage();
                    yOffset = 20;
                    doc.text('Relatório de Encaminhamento:', 20, yOffset);
                    yOffset += 5;
                    const relatorioLines = doc.splitTextToSize(relatorio, 170);
                    doc.text(relatorioLines, 20, yOffset);
                    yOffset += (relatorioLines.length * 7) + 5;
                    yOffset = yOffset > 270 ? 20 : yOffset; // Quebra de página
                }
            }
            
            // Demandas
            const demandasSelecionadas = Array.from(document.querySelectorAll(`input[name="demandas${activeTab === 'tecnico' ? '_tecnico' : ''}"]:checked`))
                                            .map(checkbox => checkbox.value);
            const outrosDemandaInput = getElementByIdForActiveTab('outrosDemandaInput').value;
            if (outrosDemandaInput) {
                demandasSelecionadas.push(`Outros: ${outrosDemandaInput}`);
            }

            if (demandasSelecionadas.length > 0) {
                doc.text('Demandas:', 20, yOffset);
                yOffset += 5;
                demandasSelecionadas.forEach(demanda => {
                    doc.text(`- ${demanda}`, 25, yOffset);
                    yOffset += 7;
                });
                yOffset += 5;
                yOffset = yOffset > 270 ? 20 : yOffset;
            }

            // Fotos
            if (activeData.fotos.length > 0) {
                if (yOffset > 200) { // Se a página estiver quase cheia
                    doc.addPage();
                    yOffset = 20;
                }
                doc.text('Fotos:', 20, yOffset);
                yOffset += 10;
                let xOffset = 20;
                activeData.fotos.forEach(fotoDataUrl => {
                    if (yOffset + 50 > doc.internal.pageSize.height) {
                        doc.addPage();
                        yOffset = 20;
                        xOffset = 20;
                    }
                    doc.addImage(fotoDataUrl, 'JPEG', xOffset, yOffset, 40, 40);
                    xOffset += 50;
                    if (xOffset > 170) {
                        xOffset = 20;
                        yOffset += 50;
                    }
                });
            }

            // Gerar o PDF e armazenar no objeto de dados
            const fileName = `relatorio_${activeData.codigoAtual}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            activeData.pdfDataUri = pdfDataUri;
            activeData.pdfFileName = fileName;

            document.getElementById('btnEnviarWhatsApp').disabled = false;
            
            window.open(pdfDataUri); // Abre o PDF em uma nova aba
        }
        
        // Função para enviar o PDF por WhatsApp
        function enviarWhatsApp() {
            const activeData = getActiveData();
            if (!activeData.pdfDataUri) {
                alert("Por favor, gere o PDF primeiro.");
                return;
            }

            // Criar um link temporário para o PDF
            const link = document.createElement('a');
            link.href = activeData.pdfDataUri;
            link.download = activeData.pdfFileName;
            document.body.appendChild(link);

            // Clicar no link para download (precisa de uma forma de enviar pelo WhatsApp, que é mais complexa)
            // A abordagem abaixo pode não funcionar em todos os navegadores/dispositivos
            // O mais confiável é pedir ao usuário para compartilhar o arquivo após o download
            alert('Clique em OK para baixar o PDF e depois anexe-o manualmente na conversa do WhatsApp.');
            link.click();
            document.body.removeChild(link);
        }

        // Funções de Autenticação
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('resetPasswordForm').style.display = 'none';
        }

        function showResetPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'block';
        }

        document.getElementById('registerBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            const messageElement = document.getElementById('authMessage');

            if (password !== confirmPassword) {
                messageElement.innerText = "As senhas não coincidem.";
                return;
            }
            if (!name || !phone) {
                messageElement.innerText = "Nome e telefone são campos obrigatórios.";
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Salvar dados adicionais no Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    phone: phone,
                    email: email
                });

                messageElement.style.color = 'green';
                messageElement.innerText = "Usuário registrado com sucesso!";
                
                setTimeout(() => {
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainAppContent').style.display = 'block';
                    gerarCodigoAtendimento();
                    // Preenche os campos do agente com os dados do usuário recém-registrado
                    getElementByIdForActiveTab('nomeAgente').value = name;
                    getElementByIdForActiveTab('telefoneAgente').value = phone;
                    getElementByIdForActiveTab('nomeTecnico').value = name;
                    getElementByIdForActiveTab('telefoneTecnico').value = phone;
                }, 2000);

            } catch (error) {
                let errorMessage = "Ocorreu um erro ao registrar. Tente novamente.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este e-mail já está em uso.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "O e-mail inserido é inválido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Erro de conexão. Verifique sua internet.";
                }
                console.error("Erro ao registrar:", error);
                messageElement.style.color = 'red';
                messageElement.innerText = errorMessage;
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageElement = document.getElementById('authMessage');
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Recuperar dados adicionais do Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    // Preenche os campos do agente com os dados do usuário
                    getElementByIdForActiveTab('nomeAgente').value = userData.name || '';
                    getElementByIdForActiveTab('telefoneAgente').value = userData.phone || '';
                    getElementByIdForActiveTab('nomeTecnico').value = userData.name || '';
                    getElementByIdForActiveTab('telefoneTecnico').value = userData.phone || '';
                }

                messageElement.style.color = 'green';
                messageElement.innerText = "Login realizado com sucesso!";
                
                setTimeout(() => {
                    document.getElementById('authScreen').style.display = 'none';
                    document.getElementById('mainAppContent').style.display = 'block';
                    gerarCodigoAtendimento();
                }, 1000);

            } catch (error) {
                let errorMessage = "Erro no login. Verifique seu e-mail e senha.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "O e-mail inserido é inválido.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "E-mail ou senha incorretos.";
                }
                console.error("Erro ao fazer login:", error);
                messageElement.style.color = 'red';
                messageElement.innerText = errorMessage;
            }
        });

        document.getElementById('resetPasswordBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const messageElement = document.getElementById('authMessage');

            try {
                await auth.sendPasswordResetEmail(email);
                messageElement.style.color = 'green';
                messageElement.innerText = "Um e-mail de redefinição de senha foi enviado para você.";
            } catch (error) {
                let errorMessage = "Ocorreu um erro ao enviar o e-mail. Verifique o endereço.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = "O e-mail inserido é inválido.";
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = "Não há usuário com este e-mail.";
                }
                console.error("Erro ao redefinir senha:", error);
                messageElement.style.color = 'red';
                messageElement.innerText = errorMessage;
            }
        });

        function logout() {
            auth.signOut().then(() => {
                // Limpa os dados do formulário
                limparFormulario();
                // Oculta o conteúdo principal e mostra a tela de autenticação
                document.getElementById('mainAppContent').style.display = 'none';
                document.getElementById('authScreen').style.display = 'block';
            }).catch((error) => {
                console.error("Erro ao fazer logout:", error);
                alert("Ocorreu um erro ao sair. Tente novamente.");
            });
        }
        
        // Listener para verificar o estado de autenticação
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainAppContent').style.display = 'block';
                gerarCodigoAtendimento();

                // Recuperar dados do usuário logado
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        getElementByIdForActiveTab('nomeAgente').value = userData.name || '';
                        getElementByIdForActiveTab('telefoneAgente').value = userData.phone || '';
                        getElementByIdForActiveTab('nomeTecnico').value = userData.name || '';
                        getElementByIdForActiveTab('telefoneTecnico').value = userData.phone || '';
                    }
                } catch (error) {
                    console.error("Erro ao recuperar dados do usuário:", error);
                }
            } else {
                document.getElementById('authScreen').style.display = 'block';
                document.getElementById('mainAppContent').style.display = 'none';
            }
        });
    </script>
</body>
</html>