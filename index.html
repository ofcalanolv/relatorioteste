<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Relatório</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f5f5f5; }
        h2, h3 { text-align: center; }
        .container { max-width: 500px; margin: auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        input, textarea, button { display: block; margin: 10px 0; padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .inline-fields { display: flex; gap: 10px; }
        .inline-fields input { flex: 1; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #0056b3; }
        #fotosPreview { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .foto-container { position: relative; display: inline-block; }
        .foto-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; border: none; border-radius: 50%; font-size: 14px; width: 20px; height: 20px; cursor: pointer; }
        #gps { font-size: 14px; color: #555; }
        #contador { font-size: 12px; text-align: right; color: #555; margin-top: -8px; }
        #codigoDisplay { font-size: 14px; font-weight: bold; text-align: center; margin-top: 10px; color: #333; }
        #mapPreview {
            width: 100%;
            height: 150px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            margin-top: 10px;
            display: none; /* Hidden by default */
            object-fit: cover;
        }
        /* Flexbox for camera buttons to ensure they display side-by-side or stacked */
        .camera-controls {
            display: flex;
            gap: 10px; /* Space between buttons */
            margin-top: 10px;
        }
        .camera-controls button {
            flex: 1; /* Make buttons take equal width */
            margin: 0; /* Remove default button margin */
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .inline-fields { flex-direction: column; }
            .camera-controls { flex-direction: column; } /* Stack buttons on small screens */
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Coleta de Dados</h2>
        <div id="codigoDisplay"></div>
        <input type="text" id="nome" placeholder="Nome">
        <input type="text" id="endereco" placeholder="Endereço (coletado automaticamente)">
        <div class="inline-fields">
            <input type="text" id="numero" placeholder="Número" oninput="atualizarEnderecoCompleto()">
            <input type="text" id="complemento" placeholder="Complemento" oninput="atualizarEnderecoCompleto()">
        </div>
        <button onclick="coletarGPS()">Coletar Endereço Atual</button>
        <img id="mapPreview" alt="Mapa da Localização">

        <input type="date" id="dataNascimento" placeholder="Data de Nascimento" onchange="calcularIdade()">
        <input type="text" id="idade" placeholder="Idade" readonly>

        <textarea id="historico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador()"></textarea>
        <div id="contador">0 / 5000</div>

        <h3>Fotos</h3>
        <button onclick="tirarFoto()">Adicionar Foto</button>
        <video id="video" width="100%" autoplay style="display:none;"></video>
        <div class="camera-controls">
            <button id="captureBtn" style="display:none;" onclick="capturarImagem()">Capturar Imagem</button>
            <button id="stopCameraBtn" style="display:none; background: #dc3545;" onclick="pararCamera()">Fechar Câmera</button>
        </div>
        <div id="fotosPreview"></div>

        <p id="gps"></p>

        <h3>Relatório</h3>
        <button onclick="gerarPDF()">Gerar PDF</button>
        <button onclick="limparFormulario()" style="background: #6c757d;">Limpar Formulário</button>
    </div>

    <script>
        let fotos = [];
        let coordenadas = "";
        let enderecoBaseDetalhes = {};
        let codigoAtual = "";
        let cameraStream = null;
        let mapImageUrl = ""; // Store the direct URL for the map image

        const addCustomFont = (doc) => {
            doc.addFont('helvetica', 'normal', 'normal');
        };

        function gerarCodigoAtendimento() {
            const agora = new Date();
            const d = String(agora.getDate()).padStart(2, '0');
            const m = String(agora.getMonth() + 1).padStart(2, '0');
            const y = agora.getFullYear();
            const h = String(agora.getHours()).padStart(2, '0');
            const min = String(agora.getMinutes()).padStart(2, '0');
            const s = String(agora.getSeconds()).padStart(2, '0');
            codigoAtual = `${d}${m}${y}-${h}${min}${s}`;
            document.getElementById('codigoDisplay').innerText = `Relatório nº: ${codigoAtual}`;
            return codigoAtual;
        }

        gerarCodigoAtendimento();

        function calcularIdade() {
            const nascimentoStr = document.getElementById('dataNascimento').value;
            const idadeInput = document.getElementById('idade');
            if (!nascimentoStr) {
                idadeInput.value = '';
                return;
            }

            const hoje = new Date();
            const nasc = new Date(nascimentoStr);

            let anos = hoje.getFullYear() - nasc.getFullYear();
            let meses = hoje.getMonth() - nasc.getMonth();
            let dias = hoje.getDate() - nasc.getDate();

            if (dias < 0) {
                meses--;
                dias += new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
            }
            if (meses < 0) {
                anos--;
                meses += 12;
            }

            let idadeTexto = `${anos} anos`;
            if (meses > 0) idadeTexto += `, ${meses} meses`;
            if (dias > 0) idadeTexto += `, ${dias} dias`;

            idadeInput.value = idadeTexto;
        }

        function atualizarContador() {
            const historico = document.getElementById('historico').value.length;
            document.getElementById('contador').innerText = `${historico} / 5000`;
        }

        async function tirarFoto() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            try {
                // Request 'environment' (rear) camera, if available
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                video.style.display = "block";
                captureBtn.style.display = "block"; // Ensure capture button is visible
                stopCameraBtn.style.display = "block";
            } catch (err) {
                console.error("Erro ao acessar a câmera:", err);
                alert("Não foi possível acessar a câmera. Verifique as permissões do navegador ou se a câmera está em uso.");
                video.style.display = "none";
                captureBtn.style.display = "none";
                stopCameraBtn.style.display = "none";
            }
        }

        function pararCamera() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cameraStream = null;
            }
            video.style.display = "none";
            captureBtn.style.display = "none";
            stopCameraBtn.style.display = "none";
        }

        function capturarImagem() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const fotoBase64 = canvas.toDataURL("image/jpeg", 0.8);

            fotos.push(fotoBase64);

            const previewDiv = document.getElementById('fotosPreview');
            const container = document.createElement('div');
            container.classList.add('foto-container');
            const img = document.createElement('img');
            img.src = fotoBase64;
            img.classList.add('foto-thumb');
            const removeBtn = document.createElement('button');
            removeBtn.innerText = "X";
            removeBtn.classList.add('remove-btn');
            removeBtn.onclick = () => {
                fotos = fotos.filter(f => f !== fotoBase64);
                container.remove();
            };
            container.appendChild(img);
            container.appendChild(removeBtn);
            previewDiv.appendChild(container);

            pararCamera(); // Stop camera after capturing
        }

        function atualizarEnderecoCompleto() {
            const numero = document.getElementById('numero').value.trim();
            const complemento = document.getElementById('complemento').value.trim();
            const enderecoInput = document.getElementById('endereco');
            
            let partes = [];
            
            // Prioriza o nome da rua do Nominatim, se houver
            if (enderecoBaseDetalhes.road) {
                partes.push(enderecoBaseDetalhes.road);
            }
            
            // Adiciona o número
            if (numero) {
                partes.push(numero);
            }

            // Adiciona o complemento
            if (complemento) {
                partes.push(complemento);
            }

            // Adiciona o restante das informações do Nominatim, se houverem e ainda não foram incluídas
            const partesEndBase = [
                enderecoBaseDetalhes.suburb || enderecoBaseDetalhes.neighbourhood,
                enderecoBaseDetalhes.city || enderecoBaseDetalhes.town || enderecoBaseDetalhes.village,
                enderecoBaseDetalhes.state
            ].filter(Boolean);

            partes = partes.concat(partesEndBase);

            // Filtra e junta as partes, garantindo que não haja vírgulas extras para campos vazios
            enderecoInput.value = partes.filter(Boolean).join(', ').replace(/, ,/g, ',').replace(/,$/, '').trim();
            
            // Caso nenhum dos 3 esteja preenchido e não tenha endereço base, o campo fica vazio
            if (!enderecoBaseDetalhes.road && !numero && !complemento && partes.filter(Boolean).length === 0) {
                 enderecoInput.value = '';
            }
        }

        async function coletarGPS() {
            document.getElementById('gps').innerText = "Coletando localização...";
            const mapPreview = document.getElementById('mapPreview');
            mapPreview.style.display = 'none'; // Hide map while loading
            mapImageUrl = ""; // Clear previous map URL

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lon = pos.coords.longitude.toFixed(6);
                    coordenadas = `Lat: ${lat}, Lng: ${lon}`;
                    document.getElementById('gps').innerText = coordenadas;

                    try {
                        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`;
                        const response = await fetch(url);
                        const data = await response.json();
                        enderecoBaseDetalhes = data.address || {};

                        atualizarEnderecoCompleto();

                        // Directly set the src for the map image
                        const zoom = 15;
                        const size = "400x200";
                        mapImageUrl = `https://static.openstreetmap.org/staticmap/osm_basic_osm_contributed.png?mlat=${lat}&mlon=${lon}&zoom=${zoom}&size=${size}&marker=dot-red`;
                        mapPreview.src = mapImageUrl;
                        mapPreview.style.display = 'block';

                    } catch (fetchError) {
                        console.error("Erro ao obter endereço do Nominatim:", fetchError);
                        document.getElementById('endereco').value = "Não foi possível obter o endereço detalhado.";
                        enderecoBaseDetalhes = {};
                        mapPreview.style.display = 'none';
                        mapImageUrl = "";
                    }
                }, (geoError) => {
                    console.error("Erro de geolocalização:", geoError);
                    let errorMessage = "Não foi possível obter a localização.";
                    if (geoError.code === geoError.PERMISSION_DENIED) {
                        errorMessage = "Permissão de localização negada. Ative nas configurações do navegador.";
                    } else if (geoError.code === geoError.POSITION_UNAVAILABLE) {
                        errorMessage = "Localização indisponível. Tente novamente.";
                    } else if (geoError.code === geoError.TIMEOUT) {
                        errorMessage = "Tempo esgotado para obter a localização.";
                    }
                    alert(errorMessage);
                    document.getElementById('gps').innerText = errorMessage;
                    enderecoBaseDetalhes = {};
                    mapPreview.style.display = 'none';
                    mapImageUrl = "";
                });
            } else {
                alert("Geolocalização não suportada neste navegador.");
                document.getElementById('gps').innerText = "Geolocalização não suportada.";
                enderecoBaseDetalhes = {};
                mapPreview.style.display = 'none';
                mapImageUrl = "";
            }
        }

        function resizeImage(base64Str, maxWidth = 800, maxHeight = 800) {
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            height = parseInt(height); // Ensure integer
                            width = parseInt(maxWidth); // Ensure integer
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            width = parseInt(width); // Ensure integer
                            height = parseInt(maxHeight); // Ensure integer
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    let ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = () => resolve(null); // Resolve with null on error
            });
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            addCustomFont(doc);

            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                alert("Por favor, preencha o campo 'Nome' para gerar o relatório.");
                return;
            }

            const enderecoFinalParaPDF = document.getElementById('endereco').value || "Não informado"; 
            const idade = document.getElementById('idade').value || "Não informada";
            const nascimento = document.getElementById('dataNascimento').value || "Não informado";
            const historico = document.getElementById('historico').value || "Não informado";
            const codigo = codigoAtual || gerarCodigoAtendimento();

            let yPos = 20;

            doc.setFontSize(18);
            doc.text(`Relatório de Usuário`, 105, yPos, { align: 'center' });
            yPos += 15;

            doc.setFontSize(12);
            doc.text(`Relatório nº: ${codigo}`, 10, yPos);
            yPos += 10;
            doc.text(`Data e Hora: ${new Date().toLocaleString('pt-BR')}`, 10, yPos);
            yPos += 15;

            doc.setFontSize(14);
            doc.text(`Dados Pessoais:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            doc.text(`Nome: ${nome}`, 10, yPos);
            yPos += 7;
            doc.text(`Data de Nascimento: ${nascimento} (Idade: ${idade})`, 10, yPos);
            yPos += 7;
            doc.text(`Endereço: ${enderecoFinalParaPDF}`, 10, yPos); 
            yPos += 7;
            doc.text(`Coordenadas: ${coordenadas || "Não coletadas"}`, 10, yPos);
            yPos += 15;

            // Add Map Image if available
            if (mapImageUrl) {
                 try {
                    // Fetch the image and convert to base64 for jsPDF
                    const response = await fetch(mapImageUrl);
                    const blob = await response.blob();
                    const mapBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });

                    if (mapBase64) {
                        if (yPos + 80 > doc.internal.pageSize.height - 10) {
                            doc.addPage();
                            yPos = 20;
                            addCustomFont(doc);
                        }
                        doc.setFontSize(14);
                        doc.text(`Localização no Mapa:`, 10, yPos);
                        yPos += 8;
                        doc.addImage(mapBase64, 'PNG', 10, yPos, 100, 50); // Adjust map size in PDF
                        yPos += 60;
                    }
                } catch (mapImgError) {
                    console.error("Erro ao adicionar imagem do mapa ao PDF:", mapImgError);
                    doc.text(`(Erro ao carregar mapa)`, 10, yPos);
                    yPos += 10;
                }
            }
            yPos += 5;

            doc.setFontSize(14);
            doc.text(`Histórico:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            let textoQuebrado = doc.splitTextToSize(historico, 180);
            doc.text(textoQuebrado, 10, yPos);
            yPos += textoQuebrado.length * 7 + 10;

            doc.setFontSize(14);
            doc.text(`Fotos:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);

            for (let i = 0; i < fotos.length; i++) {
                if (yPos + 70 > doc.internal.pageSize.height - 10) {
                    doc.addPage();
                    yPos = 20;
                    addCustomFont(doc);
                }

                try {
                    const resizedFoto = await resizeImage(fotos[i], 200, 200);
                    if (resizedFoto) { // Only add if resize was successful
                        doc.addImage(resizedFoto, 'JPEG', 10, yPos, 60, 60);
                        yPos += 70;
                    } else {
                         doc.text(`(Falha ao processar foto ${i + 1})`, 10, yPos);
                         yPos += 10;
                    }
                } catch (imgError) {
                    console.error("Erro ao adicionar imagem ao PDF:", imgError);
                    doc.text(`(Erro ao carregar foto ${i + 1})`, 10, yPos);
                    yPos += 10;
                }
            }

            doc.save(`relatorio-${codigo}.pdf`);
        }

        function limparFormulario() {
            document.getElementById('nome').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('complemento').value = '';
            document.getElementById('dataNascimento').value = '';
            document.getElementById('idade').value = '';
            document.getElementById('historico').value = '';
            document.getElementById('contador').innerText = '0 / 5000';
            document.getElementById('gps').innerText = '';
            
            fotos = [];
            document.getElementById('fotosPreview').innerHTML = '';

            pararCamera();

            coordenadas = "";
            enderecoBaseDetalhes = {};
            mapImageUrl = ""; // Clear map URL
            document.getElementById('mapPreview').src = ""; // Clear map image source
            document.getElementById('mapPreview').style.display = 'none';

            gerarCodigoAtendimento();
            alert("Formulário limpo e novo código de relatório gerado!");
        }
    </script>
</body>
</html>