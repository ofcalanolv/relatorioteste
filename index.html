<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Relatório</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 10px; 
            background: #f5f5f5; 
            padding-bottom: 70px; /* Add padding for the fixed taskbar */
        }
        h2, h3 { text-align: center; }
        .container { 
            max-width: 500px; 
            margin: auto; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; /* Space above the taskbar */
        }
        input, textarea { 
            display: block; 
            margin: 10px 0; 
            padding: 10px; 
            width: 100%; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 16px; 
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .inline-fields { display: flex; gap: 10px; }
        .inline-fields input { flex: 1; }
        #fotosPreview { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .foto-container { position: relative; display: inline-block; }
        .foto-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
        .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            font-size: 14px; 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        #gps { font-size: 14px; color: #555; }
        #contador { font-size: 12px; text-align: right; color: #555; margin-top: -8px; }
        #codigoDisplay { font-size: 14px; font-weight: bold; text-align: center; margin-top: 10px; color: #333; }
        #mapPreview {
            width: 100%;
            height: 150px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            margin-top: 10px;
            display: none; /* Hidden by default */
            object-fit: cover;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .camera-controls button {
            flex: 1;
            margin: 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer;
        }
        .camera-controls button:hover { background: #0056b3; }

        /* Taskbar Styles */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 1000; /* Ensure it stays on top */
        }
        .taskbar button {
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
            flex: 1; /* Distribute space evenly */
            margin: 0 2px; /* Small margin between buttons */
        }
        .taskbar button:hover {
            background: #555;
        }
        .taskbar button i {
            font-size: 24px; /* Icon size */
        }
        .taskbar button span {
            font-size: 10px; /* Label size */
            white-space: nowrap; /* Keep label on one line */
        }
        
        /* Specific button colors */
        #btnColetarGPS { background: #007bff; }
        #btnColetarGPS:hover { background: #0056b3; }
        #btnTirarFoto { background: #28a745; }
        #btnTirarFoto:hover { background: #218838; }
        #btnGerarPDF { background: #ffc107; color: #333; } /* Adjusted color for visibility */
        #btnGerarPDF:hover { background: #e0a800; }
        #btnLimparFormulario { background: #dc3545; }
        #btnLimparFormulario:hover { background: #c82333; }


        @media (max-width: 600px) {
            .inline-fields { flex-direction: column; }
            .camera-controls { flex-direction: column; }
            .taskbar button {
                padding: 5px 5px; /* Adjust padding for smaller screens */
            }
            .taskbar button i {
                font-size: 20px; /* Smaller icons on small screens */
            }
            .taskbar button span {
                font-size: 9px; /* Smaller labels on small screens */
            }
        }

        /* --- Login Page Styles --- */
        #loginContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above all else */
        }
        #loginBox {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        #loginBox h2 {
            margin-bottom: 20px;
            color: #333;
        }
        #loginBox input {
            margin-bottom: 15px;
        }
        #loginBox button {
            background: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        #loginBox button:hover {
            background: #0056b3;
        }
        #loginBox p {
            margin-top: 15px;
            font-size: 14px;
            cursor: pointer;
            color: #007bff;
        }
        #loginBox p:hover {
            text-decoration: underline;
        }
        #loginStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1001;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <div id="loginBox">
            <h2 id="loginTitle">Entrar</h2>
            <input type="text" id="loginUsername" placeholder="Nome de Usuário">
            <input type="password" id="loginPassword" placeholder="Senha">
            <input type="text" id="loginPhone" placeholder="Telefone (Cadastro)" style="display:none;">
            <button id="loginButton" onclick="handleLoginRegister()">Entrar</button>
            <p id="toggleLoginRegister" onclick="toggleLoginRegister()">Não tem conta? Cadastre-se</p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <h2>Coleta de Dados</h2>
        <div id="codigoDisplay"></div>
        <input type="text" id="nome" placeholder="Nome">
        <input type="text" id="endereco" placeholder="Endereço (coletado automaticamente)" readonly>
        <div class="inline-fields">
            <input type="text" id="numero" placeholder="Número" oninput="atualizarEnderecoCompleto()">
            <input type="text" id="complemento" placeholder="Complemento" oninput="atualizarEnderecoCompleto()">
        </div>
        <img id="mapPreview" alt="Mapa da Localização">

        <input type="text" id="dataNascimento" placeholder="DD/MM/AAAA" oninput="formatarDataNascimento(this)" onchange="calcularIdade()" maxlength="10">
        <input type="text" id="idade" placeholder="Idade" readonly>

        <textarea id="historico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador()"></textarea>
        <div id="contador">0 / 5000</div>

        <h3>Fotos</h3>
        <video id="video" width="100%" autoplay style="display:none;" playsinline></video>
        <div class="camera-controls">
            <button id="captureBtn" style="display:none;" onclick="capturarImagem()">Capturar Imagem</button>
            <button id="stopCameraBtn" style="display:none; background: #dc3545;" onclick="pararCamera()">Fechar Câmera</button>
        </div>
        <div id="fotosPreview"></div>

        <p id="gps"></p>
    </div>

    <div class="taskbar" id="mainTaskbar" style="display:none;">
        <button id="btnColetarGPS" onclick="coletarGPS()">
            <i class="fas fa-map-marker-alt"></i>
            <span>Endereço</span>
        </button>
        <button id="btnTirarFoto" onclick="tirarFoto()">
            <i class="fas fa-camera"></i>
            <span>Foto</span>
        </button>
        <button id="btnGerarPDF" onclick="gerarPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>Gerar PDF</span>
        </button>
        <button id="btnLimparFormulario" onclick="limparFormulario()">
            <i class="fas fa-broom"></i>
            <span>Limpar</span>
        </button>
    </div>

    <div id="loginStatus"></div>

    <script>
        const Maps_API_KEY = "AIzaSyATdDuH-ptUpN_UsZpotGX4Xe83AvUVF-E"; 

        let fotos = [];
        let coordenadas = "";
        let enderecoBaseDetalhes = {};
        let codigoAtual = "";
        let cameraStream = null;
        let mapImageUrl = ""; 
        
        let loggedInUser = null; // Store current logged in user's data

        // --- User Authentication Variables ---
        // For a real application, you'd use a backend server and database.
        // For this local HTML, we'll use localStorage to simulate.
        const USERS_STORAGE_KEY = 'registeredUsers';

        function addCustomFont(doc) {
            doc.addFont('helvetica', 'normal', 'normal');
        }

        function gerarCodigoAtendimento() {
            const agora = new Date();
            const d = String(agora.getDate()).padStart(2, '0');
            const m = String(agora.getMonth() + 1).padStart(2, '0');
            const y = agora.getFullYear();
            const h = String(agora.getHours()).padStart(2, '0');
            const min = String(agora.getMinutes()).padStart(2, '0');
            const s = String(agora.getSeconds()).padStart(2, '0');
            codigoAtual = `${d}${m}${y}-${h}${min}${s}`;
            document.getElementById('codigoDisplay').innerText = `Relatório nº: ${codigoAtual}`;
            return codigoAtual;
        }

        // --- Date Formatting and Age Calculation ---
        function formatarDataNascimento(input) {
            let value = input.value.replace(/\D/g, ''); 
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += value.substring(0, 2);
            }
            if (value.length > 2) {
                formattedValue += '/' + value.substring(2, 4);
            }
            if (value.length > 4) {
                formattedValue += '/' + value.substring(4, 8);
            }
            input.value = formattedValue;
        }

        function calcularIdade() {
            const nascimentoStr = document.getElementById('dataNascimento').value;
            const idadeInput = document.getElementById('idade');
            if (!nascimentoStr || nascimentoStr.length !== 10 || !nascimentoStr.includes('/')) {
                idadeInput.value = '';
                return;
            }

            const partes = nascimentoStr.split('/');
            if (partes.length !== 3) {
                idadeInput.value = '';
                return;
            }
            const nascFormatado = `${partes[2]}-${partes[1]}-${partes[0]}`;
            const nasc = new Date(nascFormatado);

            if (isNaN(nasc.getTime())) {
                idadeInput.value = '';
                return;
            }

            const hoje = new Date();
            
            let anos = hoje.getFullYear() - nasc.getFullYear();
            let meses = hoje.getMonth() - nasc.getMonth();
            let dias = hoje.getDate() - nasc.getDate();

            if (dias < 0) {
                meses--;
                dias += new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
            }
            if (meses < 0) {
                anos--;
                meses += 12;
            }

            let idadeTexto = `${anos} anos`;
            if (meses > 0) idadeTexto += `, ${meses} meses`;
            if (dias > 0) idadeTexto += `, ${dias} dias`;

            idadeInput.value = idadeTexto;
        }

        function atualizarContador() {
            const historico = document.getElementById('historico').value.length;
            document.getElementById('contador').innerText = `${historico} / 5000`;
        }

        // --- Camera Functions ---
        async function tirarFoto() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');

            if (cameraStream && cameraStream.active) {
                video.style.display = "block";
                captureBtn.style.display = "block";
                stopCameraBtn.style.display = "block";
                return; 
            }

            try {
                video.setAttribute('playsinline', ''); 
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                video.style.display = "block";
                captureBtn.style.display = "block"; 
                stopCameraBtn.style.display = "block";
                video.play();
            } catch (err) {
                console.error("Erro ao acessar a câmera:", err);
                alert("Não foi possível acessar a câmera. Verifique as permissões do navegador ou se a câmera está em uso.");
                video.style.display = "none";
                captureBtn.style.display = "none";
                stopCameraBtn.style.display = "none";
            }
        }

        function pararCamera() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null; 
                cameraStream = null; 
                video.pause(); 
            }
            video.style.display = "none";
            captureBtn.style.display = "none";
            stopCameraBtn.style.display = "none";
        }

        function capturarImagem() {
            const video = document.getElementById('video');
            if (!video.srcObject) { 
                alert("Câmera não está ativa para captura.");
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const fotoBase64 = canvas.toDataURL("image/jpeg", 0.8);

            fotos.push(fotoBase64);

            const previewDiv = document.getElementById('fotosPreview');
            const container = document.createElement('div');
            container.classList.add('foto-container');
            const img = document.createElement('img');
            img.src = fotoBase64;
            img.classList.add('foto-thumb');
            const removeBtn = document.createElement('button');
            removeBtn.innerText = "X";
            removeBtn.classList.add('remove-btn');
            removeBtn.onclick = () => {
                fotos = fotos.filter(f => f !== fotoBase64);
                container.remove();
            };
            container.appendChild(img);
            container.appendChild(removeBtn);
            previewDiv.appendChild(container);
        }

        // --- GPS and Map Functions ---
        function atualizarEnderecoCompleto() {
            const numero = document.getElementById('numero').value.trim();
            const complemento = document.getElementById('complemento').value.trim();
            const enderecoInput = document.getElementById('endereco');
            
            let partes = [];
            
            if (enderecoBaseDetalhes.road) {
                partes.push(enderecoBaseDetalhes.road);
            }
            
            if (numero) {
                partes.push(numero);
            }

            if (complemento) {
                partes.push(complemento);
            }

            const partesEndBase = [
                enderecoBaseDetalhes.suburb || enderecoBaseDetalhes.neighbourhood,
                enderecoBaseDetalhes.city || enderecoBaseDetalhes.town || enderecoBaseDetalhes.village,
                enderecoBaseDetalhes.state
            ].filter(Boolean);

            partes = partes.concat(partesEndBase);

            enderecoInput.value = partes.filter(Boolean).join(', ').replace(/, ,/g, ',').replace(/,$/, '').trim();
            
            if (!enderecoBaseDetalhes.road && !numero && !complemento && partes.filter(Boolean).length === 0) {
                 enderecoInput.value = '';
            }
        }

        async function coletarGPS() {
            document.getElementById('gps').innerText = "Coletando localização...";
            const mapPreview = document.getElementById('mapPreview');
            mapPreview.style.display = 'none';
            mapImageUrl = ""; 

            if (!Maps_API_KEY || Maps_API_KEY === "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI") {
                alert("Por favor, configure sua CHAVE DE API DO GOOGLE MAPS no código para que o mapa funcione.");
                document.getElementById('gps').innerText = "Erro: API Key do Google não configurada.";
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lon = pos.coords.longitude.toFixed(6);
                    coordenadas = `Lat: ${lat}, Lng: ${lon}`;
                    document.getElementById('gps').innerText = coordenadas;

                    try {
                        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`;
                        const nominatimResponse = await fetch(nominatimUrl);
                        const nominatimData = await nominatimResponse.json();
                        enderecoBaseDetalhes = nominatimData.address || {};

                        atualizarEnderecoCompleto();

                        const zoom = 15;
                        const size = "400x200"; 
                        const marker = `markers=color:red%7Clabel:P%7C${lat},${lon}`;
                        
                        mapImageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lon}&zoom=${zoom}&size=${size}&${marker}&key=${Maps_API_KEY}`;
                        
                        mapPreview.src = mapImageUrl;
                        mapPreview.style.display = 'block';

                    } catch (fetchError) {
                        console.error("Erro ao obter endereço ou mapa:", fetchError);
                        document.getElementById('endereco').value = "Não foi possível obter o endereço detalhado.";
                        enderecoBaseDetalhes = {};
                        mapPreview.style.display = 'none';
                        mapImageUrl = "";
                        alert("Erro ao carregar endereço ou mapa. Verifique a API Key do Google e a conexão.");
                    }
                }, (geoError) => {
                    console.error("Erro de geolocalização:", geoError);
                    let errorMessage = "Não foi possível obter a localização.";
                    if (geoError.code === geoError.PERMISSION_DENIED) {
                        errorMessage = "Permissão de localização negada. Ative nas configurações do navegador.";
                    } else if (geoError.code === geoError.POSITION_UNAVAILABLE) {
                        errorMessage = "Localização indisponível. Tente novamente.";
                    } else if (geoError.code === geoError.TIMEOUT) {
                        errorMessage = "Tempo esgotado para obter a localização.";
                    }
                    alert(errorMessage);
                    document.getElementById('gps').innerText = errorMessage;
                    enderecoBaseDetalhes = {};
                    mapPreview.style.display = 'none';
                    mapImageUrl = "";
                });
            } else {
                alert("Geolocalização não suportada neste navegador.");
                document.getElementById('gps').innerText = "Geolocalização não suportada.";
                enderecoBaseDetalhes = {};
                mapPreview.style.display = 'none';
                mapImageUrl = "";
            }
        }

        // --- Image Resizing (Adjusted for 4:3 Aspect Ratio) ---
        function resizeImage(base64Str, targetWidth = 600) { // Target width for the resized image for PDF
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let originalWidth = img.width;
                    let originalHeight = img.height;

                    // Calculate target height to maintain 4:3 aspect ratio (width/height = 4/3)
                    // If original is vertical, rotate it conceptually before resizing to 4:3 landscape
                    let isLandscape = originalWidth >= originalHeight;
                    let width, height;

                    if (isLandscape) {
                        width = targetWidth;
                        height = (targetWidth / 4) * 3; // Maintain 4:3 aspect ratio
                    } else { // Original is portrait
                        // Rotate it conceptually to landscape (height becomes width, width becomes height for calculation)
                        width = targetWidth;
                        height = (targetWidth / 4) * 3;
                        // To achieve 4:3 landscape from portrait, we might crop or letterbox.
                        // For simplicity, we just resize to fit the 4:3 target while maintaining aspect.
                        // This might result in letterboxing or stretching if original is not 4:3
                        // A more advanced solution would involve cropping the center
                        // For now, let's fit the longest side to our target width, and adjust height
                        // and then crop if necessary for strict 4:3 or pad
                        
                        // Let's force it to 4:3 landscape directly for simplicity
                        // The drawn image will be scaled to fit this canvas
                        if (originalWidth / originalHeight > 4 / 3) { // Original is wider than 4:3
                            height = (originalHeight / originalWidth) * targetWidth;
                            width = targetWidth;
                        } else { // Original is taller than 4:3 or 4:3
                            width = (originalWidth / originalHeight) * ((targetWidth / 4) * 3);
                            height = (targetWidth / 4) * 3;
                        }
                    }

                    canvas.width = targetWidth;
                    canvas.height = (targetWidth / 4) * 3; // Ensure canvas is 4:3

                    let ctx = canvas.getContext('2d');
                    ctx.fillStyle = "#FFFFFF"; // Fill background with white
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Calculate scaling factor to fit the image inside the 4:3 canvas
                    let scale = Math.min(canvas.width / originalWidth, canvas.height / originalHeight);
                    let imgX = (canvas.width / 2) - (originalWidth / 2) * scale;
                    let imgY = (canvas.height / 2) - (originalHeight / 2) * scale;

                    ctx.drawImage(img, imgX, imgY, originalWidth * scale, originalHeight * scale);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); // Use 0.8 quality for better balance
                };
                img.onerror = () => {
                    console.warn("Falha ao carregar ou redimensionar imagem (Base64 inválido ou erro de rede).");
                    resolve(null);
                };
            });
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            addCustomFont(doc);

            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                alert("Por favor, preencha o campo 'Nome' para gerar o relatório.");
                return;
            }

            const enderecoFinalParaPDF = document.getElementById('endereco').value || "Não informado"; 
            const idade = document.getElementById('idade').value || "Não informada";
            const nascimento = document.getElementById('dataNascimento').value || "Não informado";
            const historico = document.getElementById('historico').value || "Não informado";
            const codigo = codigoAtual || gerarCodigoAtendimento();

            let yPos = 20;

            doc.setFontSize(18);
            doc.text(`Relatório de Usuário`, 105, yPos, { align: 'center' });
            yPos += 15;

            doc.setFontSize(12);
            doc.text(`Relatório nº: ${codigo}`, 10, yPos);
            yPos += 10;
            doc.text(`Data e Hora: ${new Date().toLocaleString('pt-BR')}`, 10, yPos);
            yPos += 5;
            if (loggedInUser) {
                doc.text(`Usuário Responsável: ${loggedInUser.username} (Tel: ${loggedInUser.phone})`, 10, yPos);
            } else {
                doc.text(`Usuário Responsável: Não logado`, 10, yPos);
            }
            yPos += 10;


            doc.setFontSize(14);
            doc.text(`Dados Pessoais:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            doc.text(`Nome: ${nome}`, 10, yPos);
            yPos += 7;
            doc.text(`Data de Nascimento: ${nascimento} (Idade: ${idade})`, 10, yPos);
            yPos += 7;
            doc.text(`Endereço: ${enderecoFinalParaPDF}`, 10, yPos); 
            yPos += 7;
            doc.text(`Coordenadas: ${coordenadas || "Não coletadas"}`, 10, yPos);
            yPos += 15;

            if (mapImageUrl && Maps_API_KEY && Maps_API_KEY !== "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI") {
                 try {
                    const response = await fetch(mapImageUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const blob = await response.blob();
                    const mapBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = () => {
                            console.error("FileReader failed to convert map blob to Base64.");
                            resolve(null);
                        };
                        reader.readAsDataURL(blob);
                    });

                    if (mapBase64) {
                        if (yPos + 80 > doc.internal.pageSize.height - 10) {
                            doc.addPage();
                            yPos = 20;
                            addCustomFont(doc);
                        }
                        doc.setFontSize(14);
                        doc.text(`Localização no Mapa:`, 10, yPos);
                        yPos += 8;
                        // Map size for PDF
                        const mapWidth = 100;
                        const mapHeight = (mapWidth / 4) * 3; // Maintain 4:3 aspect ratio
                        doc.addImage(mapBase64, 'PNG', 10, yPos, mapWidth, mapHeight); 
                        yPos += mapHeight + 10;
                    } else {
                         doc.text(`(Falha ao processar mapa para PDF - Base64 vazio)`, 10, yPos);
                         yPos += 10;
                    }
                } catch (mapImgError) {
                    console.error("Erro ao adicionar imagem do mapa ao PDF:", mapImgError);
                    doc.text(`(Erro ao carregar mapa para PDF)`, 10, yPos);
                    yPos += 10;
                }
            } else if (mapImageUrl && (!Maps_API_KEY || Maps_API_KEY === "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI")) {
                doc.text(`(Mapa não incluído: Chave de API do Google ausente/inválida)`, 10, yPos);
                yPos += 10;
            }
            yPos += 5;

            doc.setFontSize(14);
            doc.text(`Histórico:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            let textoQuebrado = doc.splitTextToSize(historico, 180);
            doc.text(textoQuebrado, 10, yPos);
            yPos += textoQuebrado.length * 7 + 10;

            doc.setFontSize(14);
            doc.text(`Fotos:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);

            // PDF image layout variables
            const imgWidth = 60; // Desired width for each image in PDF (mm)
            const imgHeight = (imgWidth / 4) * 3; // Calculated height for 4:3 aspect ratio (mm)
            const imgMargin = 5; // Margin between images (mm)
            const startX = 10; // Starting X position for images
            let currentX = startX;
            let imagesInRow = 0;

            for (let i = 0; i < fotos.length; i++) {
                // Check if current row has space for new image, or if it's a new page
                if (imagesInRow === 3 || (yPos + imgHeight + 10 > doc.internal.pageSize.height - 10 && imagesInRow > 0)) {
                    doc.addPage();
                    yPos = 20; // Reset yPos for new page
                    currentX = startX; // Reset X position
                    imagesInRow = 0; // Reset image counter for new row/page
                    addCustomFont(doc); // Re-add font for new page
                } else if (yPos + imgHeight + 10 > doc.internal.pageSize.height - 10 && imagesInRow === 0) {
                     // If it's the first image of a new row and no space, just add page
                     doc.addPage();
                     yPos = 20;
                     currentX = startX;
                     imagesInRow = 0;
                     addCustomFont(doc);
                }


                try {
                    const resizedFoto = await resizeImage(fotos[i], 600); // Pass a target width (e.g., 600px for good quality)
                    if (resizedFoto) {
                        doc.addImage(resizedFoto, 'JPEG', currentX, yPos, imgWidth, imgHeight);
                        currentX += imgWidth + imgMargin; // Move X for next image
                        imagesInRow++;

                        if (imagesInRow === 3) { // If 3 images in row, reset for next row
                            yPos += imgHeight + imgMargin;
                            currentX = startX;
                            imagesInRow = 0;
                        }
                    } else {
                         console.warn(`Could not process photo ${i + 1} for PDF.`);
                    }
                } catch (imgError) {
                    console.error("Erro ao adicionar imagem ao PDF:", imgError);
                }
            }

            doc.save(`relatorio-${codigo}.pdf`);
        }

        function limparFormulario() {
            document.getElementById('nome').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('complemento').value = '';
            document.getElementById('dataNascimento').value = '';
            document.getElementById('idade').value = '';
            document.getElementById('historico').value = '';
            document.getElementById('contador').innerText = '0 / 5000';
            document.getElementById('gps').innerText = '';
            
            fotos = [];
            document.getElementById('fotosPreview').innerHTML = '';

            pararCamera();

            coordenadas = "";
            enderecoBaseDetalhes = {};
            mapImageUrl = ""; 
            document.getElementById('mapPreview').src = "";
            document.getElementById('mapPreview').style.display = 'none';

            gerarCodigoAtendimento();
            alert("Formulário limpo e novo código de relatório gerado!");
        }

        // --- User Authentication Functions ---
        let isRegistering = false; // To toggle between login and register

        function loadUsers() {
            const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
            return usersJson ? JSON.parse(usersJson) : [];
        }

        function saveUsers(users) {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
        }

        function toggleLoginRegister() {
            isRegistering = !isRegistering;
            const loginTitle = document.getElementById('loginTitle');
            const loginPhone = document.getElementById('loginPhone');
            const loginButton = document.getElementById('loginButton');
            const toggleButton = document.getElementById('toggleLoginRegister');

            if (isRegistering) {
                loginTitle.innerText = "Cadastre-se";
                loginPhone.style.display = "block";
                loginButton.innerText = "Cadastrar";
                toggleButton.innerText = "Já tem conta? Entrar";
            } else {
                loginTitle.innerText = "Entrar";
                loginPhone.style.display = "none";
                loginButton.innerText = "Entrar";
                toggleButton.innerText = "Não tem conta? Cadastre-se";
            }
        }

        function handleLoginRegister() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            let users = loadUsers();

            if (isRegistering) {
                // Register
                if (!username || !password || !phone) {
                    alert("Por favor, preencha todos os campos para se cadastrar.");
                    return;
                }
                if (users.some(u => u.username === username)) {
                    alert("Nome de usuário já existe. Escolha outro.");
                    return;
                }
                users.push({ username, password, phone });
                saveUsers(users);
                alert("Usuário cadastrado com sucesso! Agora você pode fazer login.");
                isRegistering = false; // Switch back to login view
                toggleLoginRegister(); // Update UI
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPhone').value = '';
            } else {
                // Login
                if (!username || !password) {
                    alert("Por favor, preencha nome de usuário e senha.");
                    return;
                }
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    loggedInUser = user;
                    document.getElementById('loginContainer').style.display = 'none'; // Hide login
                    document.getElementById('appContainer').style.display = 'block'; // Show app
                    document.getElementById('mainTaskbar').style.display = 'flex'; // Show taskbar
                    document.getElementById('loginStatus').innerText = `Logado como: ${loggedInUser.username}`;
                    document.getElementById('loginStatus').style.display = 'block';
                    gerarCodigoAtendimento(); // Generate initial report code
                    alert(`Bem-vindo, ${loggedInUser.username}!`);
                } else {
                    alert("Nome de usuário ou senha incorretos.");
                }
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if there are any registered users. If not, force registration view.
            const users = loadUsers();
            if (users.length === 0) {
                isRegistering = true;
                toggleLoginRegister();
                alert("Nenhum usuário cadastrado. Por favor, cadastre um novo usuário.");
            } else {
                // Keep the default login view
                toggleLoginRegister(); // Call once to ensure initial state is login
                isRegistering = false;
            }
        });
    </script>
</body>
</html>