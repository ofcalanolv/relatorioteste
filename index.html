<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Cadastro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script>
      // Substitua os valores abaixo pelas suas credenciais reais do firebaseConfig
      const firebaseConfig = {
        apiKey: "sua-chave-api",
        authDomain: "seu-dominio.firebaseapp.com",
        projectId: "seu-projeto",
        storageBucket: "seu-storage.appspot.com",
        messagingSenderId: "seu-sender-id",
        appId: "seu-app-id"
      };
      
      // Inicialize o Firebase
      firebase.initializeApp(firebaseConfig);

      // Crie a referência para o banco de dados e storage
      const db = firebase.firestore();
      const storage = firebase.storage();
    </script>
    
    <style>
        /* Variáveis CSS para cores */
        :root {
            --primary-color: #007bff; /* Azul para destaque/ações */
            --primary-dark: #0056b3;
            --secondary-color: #6c757d; /* Cinza para texto secundário */
            --bg-light: #f8f9fa; /* Fundo claro */
            --bg-medium: #e9ecef; /* Fundo de elementos */
            --text-dark: #343a40; /* Texto principal */
            --text-light: #ffffff; /* Texto claro */
            --border-color: #dee2e6; /* Cor de borda */
            --red-color: #dc3545; /* Vermelho para alerta/erro */
            --green-color: #28a745; /* Verde para sucesso */
            --whatsapp-green: #25d366; /* Verde WhatsApp */
            --whatsapp-green-dark: #1da851;
            --yellow-color: #ffc107; /* Amarelo para aviso */
            --yellow-dark: #e0a800;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; /* Fonte mais profissional */
            margin: 0;
            background: var(--bg-light);
            padding-bottom: 70px; /* Padding para a taskbar fixa */
            color: var(--text-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased; /* Suavização de fonte */
            -moz-osx-font-smoothing: grayscale; /* Suavização de fonte */
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 15px; /* Restaura a margem superior */
            margin-bottom: 5px; /* Espaçamento menor para o código */
            font-size: 2em;
            font-weight: 600;
        }

        h3 {
            text-align: left; /* Alinhamento para títulos de grupo */
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .container {
            max-width: 600px; /* Um pouco mais largo para melhor espaçamento */
            margin: 20px auto;
            background: var(--text-light);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Sombra mais suave */
            margin-bottom: 30px;
        }

        input,
        select,
        textarea {
            display: block;
            margin: 15px 0; /* Mais espaçamento vertical */
            padding: 12px 15px;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Bordas mais arredondadas */
            font-size: 1em;
            color: var(--text-dark);
            background-color: var(--bg-light);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); /* Sombra no foco */
            outline: none;
        }

        input:disabled, select:disabled, textarea:disabled {
            background-color: var(--bg-medium);
            color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.9;
        }

        .inline-fields {
            display: flex;
            gap: 15px; /* Mais espaçamento entre campos */
        }
        .inline-fields input, .inline-fields select { /* Aplica estilo também para select */
            flex: 1;
        }

        #fotosPreview, #fotosDocumentoPreview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Espaçamento entre as miniaturas */
            margin-top: 20px;
            padding: 5px;
            border: 1px dashed var(--border-color); /* Borda discreta para a área de preview */
            border-radius: 8px;
            min-height: 90px; /* Altura mínima para mostrar a área */
            justify-content: center; /* Centraliza as miniaturas */
            align-items: center;
        }

        .foto-container {
            position: relative;
            display: inline-block;
            border-radius: 8px;
            overflow: hidden; /* Garante que a imagem respeite o border-radius */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .foto-thumb {
            width: 90px; /* Um pouco maior */
            height: 90px; /* Um pouco maior */
            object-fit: cover;
            display: block; /* Remove espaço extra abaixo da imagem */
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--red-color);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            font-size: 0.8em;
            width: 24px; /* Maior para melhor toque */
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            transition: background 0.2s, opacity 0.2s;
        }
        .remove-btn:hover {
            background: #c82333;
            opacity: 1;
        }

        #gps, #gpsTecnico { /* Aplica estilo ao GPS de ambas as abas */
            font-size: 0.9em;
            color: var(--secondary-color);
            text-align: center;
            margin-top: 10px;
        }

        #contador, #contadorTecnico, #contadorRelatorioEncaminhamento { /* Aplica estilo aos contadores */
            font-size: 0.85em;
            text-align: right;
            color: var(--secondary-color);
            margin-top: -10px; /* Ajuste para ficar mais próximo da textarea */
            margin-bottom: 10px;
        }

        #codigoDisplay, #codigoDisplayTecnico {
            font-size: 0.85em; /* Tamanho menor */
            font-weight: 500;
            text-align: center;
            margin-top: 5px; /* Ajuste para ficar abaixo do h2 */
            margin-bottom: 20px;
            color: var(--secondary-color);
            padding: 4px 8px; /* Padding menor */
            background: var(--bg-medium);
            border-radius: 6px;
            display: inline-block; /* Para centralizar com text-align no pai */
            width: auto;
            max-width: 80%;
            box-sizing: border-box;
        }

        /* Removido o estilo para #mapPreview, pois o elemento será removido */

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Para botões em duas linhas em telas pequenas */
        }

        .camera-controls button {
            flex: 1;
            margin: 0;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            color: var(--text-light);
        }
        .camera-controls button#captureBtn { background: var(--primary-color); }
        .camera-controls button#captureBtn:hover { background: var(--primary-dark); }
        .camera-controls button#stopCameraBtn { background: var(--red-color); }
        .camera-controls button#stopCameraBtn:hover { background: #c82333; }
        
        /* #cameraMessage foi removido do HTML e do CSS */

        /* Taskbar Styles */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--text-light); /* Fundo claro para a taskbar */
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0; /* Padding ajustado */
            box-shadow: 0 -4px 15px rgba(0,0,0,0.08); /* Sombra suave para cima */
            z-index: 1000;
        }

        .taskbar button {
            background: none;
            border: none;
            color: var(--secondary-color); /* Cor dos ícones/texto */
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
            flex: 1;
            margin: 0 4px;
        }

        .taskbar button:not(:disabled):hover {
            background: var(--bg-medium);
            color: var(--primary-color);
        }

        .taskbar button i {
            font-size: 1.6em; /* Tamanho dos ícones */
            margin-bottom: 3px;
        }

        .taskbar button span {
            font-size: 0.75em; /* Tamanho do label */
            white-space: nowrap;
        }

        /* Cores específicas dos botões da taskbar */
        .taskbar button#btnColetarGPS { color: var(--primary-color); }
        .taskbar button#btnTirarFoto { color: var(--green-color); }
        .taskbar button#btnGerarPDF { color: var(--yellow-dark); } /* Amarelo mais escuro para melhor contraste */
        .taskbar button#btnLimparFormulario { color: var(--red-color); }
        .taskbar button#btnEnviarWhatsApp { color: var(--whatsapp-green); }

        /* Estado desabilitado para botões da taskbar */
        .taskbar button:disabled {
            color: var(--border-color); /* Cor mais clara para desabilitado */
            cursor: not-allowed;
            opacity: 0.6;
        }


        @media (max-width: 768px) {
            .container {
                margin: 15px auto;
                padding: 20px;
                border-radius: 0; /* Remover borda em telas pequenas para parecer mais integrado */
                box-shadow: none;
            }
            .inline-fields { flex-direction: column; gap: 0; }
            .inline-fields input, .inline-fields select { margin-bottom: 10px; } /* Ajuste para select */

            .camera-controls { flex-direction: column; gap: 8px; }

            .taskbar {
                padding: 5px 0;
            }
            .taskbar button {
                padding: 5px 5px;
                gap: 2px;
            }
            .taskbar button i {
                font-size: 1.4em;
            }
            .taskbar button span {
                font-size: 0.7em;
            }
        }

        /* Checkbox demands styling */
        .demand-group {
            margin-top: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            background: var(--bg-light);
        }

        .demand-items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 25px; /* Espaçamento horizontal e vertical */
            justify-content: flex-start;
        }
        .demand-item {
            display: flex;
            align-items: center;
        }
        .demand-item input[type="checkbox"] {
            width: auto;
            margin: 0; /* Remove margem padrão */
            margin-right: 10px; /* Espaçamento entre checkbox e label */
            transform: scale(1.1); /* Um pouco maior */
            accent-color: var(--primary-color); /* Cor do checkbox quando marcado */
        }
        .demand-item label {
            font-size: 0.95em;
            cursor: pointer;
            color: var(--text-dark);
        }
        #outrosDemandaContainer, #outrosDemandaContainerTecnico {
            margin-top: 20px;
            width: 100%;
        }
        #outrosDemandaInput, #outrosDemandaInputTecnico {
            margin-top: 5px;
            width: calc(100% - 30px); /* Ajusta para padding do input */
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            justify-content: center;
            background: var(--bg-medium);
            padding: 0;
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky; /* Fixa as abas no topo */
            top: 0;
            z-index: 100; /* Garante que fique acima de outros elementos */
        }
        .tab-button {
            flex: 1;
            padding: 18px 25px; /* Mais padding para maior área de clique */
            cursor: pointer;
            border: none;
            background: var(--bg-medium);
            font-size: 1.1em;
            color: var(--secondary-color);
            transition: background 0.3s, color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
            text-align: center;
            font-weight: 600;
        }
        .tab-button:hover {
            background: var(--bg-light);
            color: var(--text-dark);
        }
        .tab-button.active {
            background: var(--text-light);
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05); /* Sombra suave para a aba ativa */
        }
        .tab-content {
            display: none;
            padding-top: 15px; /* Espaçamento entre a aba e o conteúdo */
        }
        .tab-content.active {
            display: block;
        }

        /* Campo de seleção (dropdown) */
        select {
            appearance: none; /* Remove estilo padrão do navegador */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23343a40" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            padding-right: 40px; /* Espaço para o ícone */
        }
        select option, select optgroup {
            background-color: var(--bg-light); /* Cor de fundo das opções */
            color: var(--text-dark);
        }
        select option:hover, select option:focus {
            background-color: var(--primary-color); /* Cor de fundo da opção em foco/hover */
            color: var(--text-light);
        }
        select option:disabled {
            color: var(--secondary-color); /* Cor para opções desabilitadas */
        }
        select option:first-child {
            color: var(--secondary-color); /* Cor para o placeholder */
        }

    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('agenteCampo')">Agente de Campo</button>
        <button class="tab-button" onclick="showTab('tecnico')">Técnico</button>
    </div>

    <div id="agenteCampo" class="tab-content active">
        <div class="container" id="appContainerAgente">
            <h2>Cadastro de Usuário</h2>
            <div id="codigoDisplay"></div> <input type="text" id="nomeAgente" placeholder="Nome do Agente Responsável">
            <input type="tel" id="telefoneAgente" placeholder="Telefone do Agente Responsável" inputmode="numeric" pattern="[0-9]*">

            <input type="text" id="nome" placeholder="Nome do Usuário">
            <input type="text" id="identidade" placeholder="Identidade">
            <input type="tel" id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'agente')">

            <input type="text" id="endereco" placeholder="Endereço (coletado automaticamente)" readonly>
            <div class="inline-fields">
                <input type="text" id="numero" placeholder="Número" oninput="atualizarEnderecoCompleto()">
                <input type="text" id="complemento" placeholder="Complemento" oninput="atualizarEnderecoCompleto()">
            </div>
            <input type="tel" id="dataNascimento" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'agente')" onchange="calcularIdade('agente')">
            <input type="text" id="idade" placeholder="Idade" readonly>

            <textarea id="historico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador()"></textarea>
            <div id="contador">0 / 5000</div>

            <div class="demand-group">
                <h3>Demandas:</h3>
                <div class="demand-items-container"> 
                    <div class="demand-item">
                        <input type="checkbox" id="demandaBanho" name="demandas" value="Banho">
                        <label for="demandaBanho">Banho</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAssistenteSocial" name="demandas" value="Assistente Social">
                        <label for="demandaAssistenteSocial">Assistente Social</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaPsicologo" name="demandas" value="Psicólogo">
                        <label for="demandaPsicologo">Psicólogo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaEncaminhamento" name="demandas" value="Encaminhamento">
                        <label for="demandaEncaminhamento">Encaminhamento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAcolhimento" name="demandas" value="Acolhimento">
                        <label for="demandaAcolhimento">Acolhimento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaDuvidas" name="demandas" value="Dúvidas">
                        <label for="demandaDuvidas">Dúvidas</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaInformacoes" name="demandas" value="Informações">
                        <label for="demandaInformacoes">Informações</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaCorteCabelo" name="demandas" value="Corte de cabelo">
                        <label for="demandaCabelo">Corte de cabelo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaOutros" name="demandas" value="Outros">
                        <label for="demandaOutros">Outros</label>
                    </div>
                </div> 
                <div id="outrosDemandaContainer" style="display:none;">
                    <input type="text" id="outrosDemandaInput" placeholder="Especifique outras demandas">
                </div>
            </div>

            <video id="video" width="100%" autoplay style="display:none;" playsinline></video>
            <div class="camera-controls">
                <button id="captureBtn" style="display:none;" onclick="capturarImagem('agente')">Capturar Imagem</button>
                <button id="stopCameraBtn" style="display:none;" onclick="pararCamera('agente')">Fechar Câmera</button>
            </div>
            <div id="fotosPreview"></div>

            <p id="gps"></p>
        </div>
    </div>

    <div id="tecnico" class="tab-content">
        <div class="container" id="appContainerTecnico">
            <h2>Cadastro de Usuário</h2>
            <div id="codigoDisplayTecnico"></div> <input type="text" id="nomeTecnico" placeholder="Nome do Técnico Responsável">
            <input type="tel" id="telefoneTecnico" placeholder="Telefone do Técnico Responsável" inputmode="numeric" pattern="[0-9]*">

            <input type="text" id="nome_tecnico" placeholder="Nome do Usuário">
            <input type="text" id="identidade_tecnico" placeholder="Identidade">
            <input type="tel" id="cpf_tecnico" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'tecnico')">

            <input type="text" id="endereco_tecnico" placeholder="Endereço (coletado automaticamente)" readonly>
            <div class="inline-fields">
                <input type="text" id="numero_tecnico" placeholder="Número" oninput="atualizarEnderecoCompleto('tecnico')">
                <input type="text" id="complemento_tecnico" placeholder="Complemento" oninput="atualizarEnderecoCompleto('tecnico')">
            </div>
            <input type="tel" id="dataNascimento_tecnico" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'tecnico')" onchange="calcularIdade('tecnico')">
            <input type="text" id="idade_tecnico" placeholder="Idade" readonly>

            <select id="cadUnico_tecnico" required>
                <option value="">Possui CAD Único?</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>

            <select id="bolsaFamilia_tecnico" required>
                <option value="">Possui Bolsa-Família?</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>

            <select id="centroRecuperacao_tecnico" required>
                <option value="">Já passou por centro de recuperação?</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
            </select>

            <textarea id="historico_tecnico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador('tecnico')"></textarea>
            <div id="contadorTecnico">0 / 5000</div>

            <textarea id="relatorioEncaminhamento_tecnico" placeholder="Relatório de Encaminhamento (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador('relatorioEncaminhamento')"></textarea>
            <div id="contadorRelatorioEncaminhamento">0 / 5000</div>

            <div class="demand-group">
                <h3>Demandas:</h3>
                <div class="demand-items-container"> 
                    <div class="demand-item">
                        <input type="checkbox" id="demandaBanho_tecnico" name="demandas_tecnico" value="Banho" onchange="checkDemandasTecnico()">
                        <label for="demandaBanho_tecnico">Banho</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAssistenteSocial_tecnico" name="demandas_tecnico" value="Assistente Social" onchange="checkDemandasTecnico()">
                        <label for="demandaAssistenteSocial_tecnico">Assistente Social</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaPsicologo_tecnico" name="demandas_tecnico" value="Psicólogo" onchange="checkDemandasTecnico()">
                        <label for="demandaPsicologo_tecnico">Psicólogo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaEncaminhamento_tecnico" name="demandas_tecnico" value="Encaminhamento" onchange="checkDemandasTecnico()">
                        <label for="demandaEncaminhamento_tecnico">Encaminhamento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAcolhimento_tecnico" name="demandas_tecnico" value="Acolhimento" onchange="checkDemandasTecnico()">
                        <label for="demandaAcolhimento_tecnico">Acolhimento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaDuvidas_tecnico" name="demandas_tecnico" value="Dúvidas" onchange="checkDemandasTecnico()">
                        <label for="demandaDuvidas_tecnico">Dúvidas</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaInformacoes_tecnico" name="demandas_tecnico" value="Informações" onchange="checkDemandasTecnico()">
                        <label for="demandaInformacoes_tecnico">Informações</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaCorteCabelo_tecnico" name="demandas_tecnico" value="Corte de cabelo" onchange="checkDemandasTecnico()">
                        <label for="demandaCabelo_tecnico">Corte de cabelo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaOutros_tecnico" name="demandas_tecnico" value="Outros" onchange="checkDemandasTecnico()">
                        <label for="demandaOutros_tecnico">Outros</label>
                    </div>
                </div> 
                <div id="outrosDemandaContainerTecnico" style="display:none;">
                    <input type="text" id="outrosDemandaInputTecnico" placeholder="Especifique outras demandas">
                </div>
            </div>

            <div class="demand-item" style="margin-top: 20px;">
                <input type="checkbox" id="atendimentoPsicossocial_tecnico" name="atendimentoPsicossocial_tecnico">
                <label for="atendimentoPsicossocial_tecnico">Atendimento Psicossocial</label>
            </div>

            <div id="fotosPreviewTecnico"></div>

            <p id="gpsTecnico"></p>
        </div>
    </div>


    <div class="taskbar" id="mainTaskbar">
        <button id="btnColetarGPS" onclick="coletarGPS()">
            <i class="fas fa-map-marker-alt"></i>
            <span>Endereço</span>
        </button>
        <button id="btnTirarFoto" onclick="tirarFoto('global')">
            <i class="fas fa-camera"></i>
            <span>Foto</span>
        </button>
        <button id="btnGerarPDF" onclick="gerarPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>Gerar PDF</span>
        </button>
        <button id="btnLimparFormulario" onclick="limparFormulario()">
            <i class="fas fa-broom"></i>
            <span>Limpar</span>
        </button>
         <button id="btnEnviarWhatsApp" onclick="enviarWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
        </button>
    </div>

    <script>
        // Dados para Agente de Campo
        let dadosAgenteCampo = {
            fotos: [], // Fotos do usuário
            coordenadas: "",
            enderecoBaseDetalhes: {}, // Mantido para o endereço textual
            codigoAtual: "",
            mapImageUrl: "", // Não será mais usado, mas mantido para evitar erros em outras partes
            pdfDataUri: null, 
            pdfFileName: "",
            agenteDadosPreenchidos: false,
            // Adicione mais campos aqui se precisar de dados separados para cada aba
            nomeAgente: "",
            telefoneAgente: "",
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            historico: "",
            demandas: []
        };

        // Dados para Técnico (inicialmente duplicados para teste)
        let dadosTecnico = {
            fotos: [], 
            coordenadas: "",
            enderecoBaseDetalhes: {}, // Mantido para o endereço textual
            codigoAtual: "",
            mapImageUrl: "", // Não será mais usado, mas mantido para evitar erros em outras partes
            pdfDataUri: null, 
            pdfFileName: "",
            agenteDadosPreenchidos: false, // Pode ser renomeado para 'tecnicoDadosPreenchidos'
            // IDs de campos da aba Técnico devem ser atualizados para pegar seus próprios valores
            nomeAgente: "", // Isso será nomeTecnico
            telefoneAgente: "", // Isso será telefoneTecnico
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            cadUnico: "",
            bolsaFamilia: "",
            centroRecuperacao: "",
            historico: "",
            relatorioEncaminhamento: "", // NOVO CAMPO
            demandas: [],
            atendimentoPsicossocial: false // NOVO CAMPO
        };

        let activeTab = 'agenteCampo'; // Controla qual aba está ativa
        let cameraStream = null; // Stream da câmera principal

        const addCustomFont = (doc) => {
            doc.addFont('helvetica', 'normal', 'normal');
        };

        function getActiveData() {
            return activeTab === 'agenteCampo' ? dadosAgenteCampo : dadosTecnico;
        }

        function getElementByIdForActiveTab(idBase, forElement = true) {
            if (activeTab === 'agenteCampo') {
                return document.getElementById(idBase);
            } else {
                // IDs para aba técnico
                if (idBase === 'codigoDisplay') return document.getElementById('codigoDisplayTecnico');
                if (idBase === 'nomeAgente') return document.getElementById('nomeTecnico');
                if (idBase === 'telefoneAgente') return document.getElementById('telefoneTecnico');
                if (idBase === 'nome') return document.getElementById('nome_tecnico');
                if (idBase === 'identidade') return document.getElementById('identidade_tecnico');
                if (idBase === 'cpf') return document.getElementById('cpf_tecnico');
                if (idBase === 'endereco') return document.getElementById('endereco_tecnico');
                if (idBase === 'numero') return document.getElementById('numero_tecnico');
                if (idBase === 'complemento') return document.getElementById('complemento_tecnico');
                if (idBase === 'dataNascimento') return document.getElementById('dataNascimento_tecnico');
                if (idBase === 'idade') return document.getElementById('idade_tecnico');
                if (idBase === 'historico') return document.getElementById('historico_tecnico');
                if (idBase === 'contador') return document.getElementById('contadorTecnico');
                if (idBase === 'demandaOutros') return document.getElementById('demandaOutros_tecnico');
                if (idBase === 'outrosDemandaContainer') return document.getElementById('outrosDemandaContainerTecnico');
                if (idBase === 'outrosDemandaInput') return document.getElementById('outrosDemandaInputTecnico');
                if (idBase === 'fotosPreview') return document.getElementById('fotosPreviewTecnico');
                if (idBase === 'gps') return document.getElementById('gpsTecnico');

                // Novos campos da aba técnico
                if (idBase === 'cadUnico') return document.getElementById('cadUnico_tecnico');
                if (idBase === 'bolsaFamilia') return document.getElementById('bolsaFamilia_tecnico');
                if (idBase === 'centroRecuperacao') return document.getElementById('centroRecuperacao_tecnico');
                if (idBase === 'relatorioEncaminhamento') return document.getElementById('relatorioEncaminhamento_tecnico'); // NOVO
                if (idBase === 'contadorRelatorioEncaminhamento') return document.getElementById('contadorRelatorioEncaminhamento'); // NOVO
                if (idBase === 'atendimentoPsicossocial') return document.getElementById('atendimentoPsicossocial_tecnico'); // NOVO
                
                // Campos de camera são compartilhados no HTML
                if (idBase === 'video' || idBase === 'captureBtn' || idBase === 'stopCameraBtn') { // cameraMessage removido
                    return document.getElementById(idBase);
                }
                
                // Para checkboxes, o 'name' é diferente
                if (idBase === 'demandas') {
                    return document.querySelectorAll(`input[name="demandas_tecnico"]`);
                } else if (forElement) { // Default para outros elementos
                    return document.getElementById(`${idBase}_tecnico`);
                }
                return null;
            }
        }


        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            activeTab = tabId; // Atualiza a aba ativa

            // Re-renderizar o código de atendimento e habilitar/desabilitar o botão do WhatsApp
            const activeData = getActiveData();
            gerarCodigoAtendimento(); // Gera um novo código para a aba ativa (ou exibe o existente)
            document.getElementById('btnEnviarWhatsApp').disabled = !activeData.pdfDataUri;
            
            // Para parar a câmera se o usuário mudar de aba com a câmera aberta
            pararCamera('global');
        }

        function gerarCodigoAtendimento() {
            const activeData = getActiveData();
            if (!activeData.codigoAtual) {
                const agora = new Date();
                const d = String(agora.getDate()).padStart(2, '0');
                const m = String(agora.getMonth() + 1).padStart(2, '0');
                const y = agora.getFullYear();
                const h = String(agora.getHours()).padStart(2, '0');
                const min = String(agora.getMinutes()).padStart(2, '0');
                const s = String(agora.getSeconds()).padStart(2, '0');
                activeData.codigoAtual = `${d}${m}${y}-${h}${min}${s}`;
            }
            getElementByIdForActiveTab('codigoDisplay').innerText = `Relatório nº: ${activeData.codigoAtual}`;
            return activeData.codigoAtual;
        }

        document.addEventListener('DOMContentLoaded', () => {
            gerarCodigoAtendimento();

            // Listeners para a aba Agente de Campo
            getElementByIdForActiveTab('demandaOutros').addEventListener('change', function() {
                const outrosContainer = getElementByIdForActiveTab('outrosDemandaContainer');
                outrosContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    getElementByIdForActiveTab('outrosDemandaInput').value = '';
                }
            });
            getElementByIdForActiveTab('telefoneAgente').addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Listeners para a aba Técnico
            getElementByIdForActiveTab('demandaOutros', false).addEventListener('change', function() {
                const outrosContainer = getElementByIdForActiveTab('outrosDemandaContainer', false);
                outrosContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    getElementByIdForActiveTab('outrosDemandaInput', false).value = '';
                }
                checkDemandasTecnico(); // Chama para verificar a necessidade do Relatório de Encaminhamento
            });

            // Adiciona um listener para todos os checkboxes de demanda do técnico
            document.querySelectorAll('input[name="demandas_tecnico"]').forEach(checkbox => {
                checkbox.addEventListener('change', checkDemandasTecnico);
            });
            getElementByIdForActiveTab('telefoneAgente', false).addEventListener('input', function (e) { // Para aba tecnico
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Adiciona listener para desabilitar campos do agente após o primeiro input
            getElementByIdForActiveTab('nomeAgente').addEventListener('blur', () => checkAndDisableAgentFields('agenteCampo'));
            getElementByIdForActiveTab('telefoneAgente').addEventListener('blur', () => checkAndDisableAgentFields('agenteCampo'));
            getElementByIdForActiveTab('nomeAgente', false).addEventListener('blur', () => checkAndDisableAgentFields('tecnico'));
            getElementByIdForActiveTab('telefoneTecnico', false).addEventListener('blur', () => checkAndDisableAgentFields('tecnico'));

            // Inicia o botão do WhatsApp desabilitado
            document.getElementById('btnEnviarWhatsApp').disabled = true;

            // Exibir a primeira aba por padrão
            showTab('agenteCampo');
        });

        function checkAndDisableAgentFields(tabId) {
            const currentData = tabId === 'agenteCampo' ? dadosAgenteCampo : dadosTecnico;
            const nomeInput = document.getElementById(tabId === 'agenteCampo' ? 'nomeAgente' : 'nomeTecnico');
            const telefoneInput = document.getElementById(tabId === 'agenteCampo' ? 'telefoneAgente' : 'telefoneTecnico');

            if (nomeInput.value.trim() !== '' && telefoneInput.value.trim() !== '' && !currentData.agenteDadosPreenchidos) {
                nomeInput.disabled = true;
                telefoneInput.disabled = true;
                currentData.agenteDadosPreenchidos = true;
            }
        }

        function formatarCPF(input, tabContext) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';
            if (value.length > 0) {
                formattedValue += value.substring(0, 3);
            }
            if (value.length > 3) {
                formattedValue += '.' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formattedValue += '.' + value.substring(6, 9);
            }
            if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
            }
            input.value = formattedValue;
            // Pula para o próximo campo após preencher 11 dígitos
            if (value.length === 11) {
                const nextField = tabContext === 'agente' ? document.getElementById('dataNascimento') : document.getElementById('dataNascimento_tecnico');
                if (nextField) {
                    nextField.focus();
                }
            }
        }

        function formatarDataNascimento(input, tabContext) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';
            if (value.length > 0) {
                formattedValue += value.substring(0, 2);
            }
            if (value.length > 2) {
                formattedValue += '/' + value.substring(2, 4);
            }
            if (value.length > 4) {
                formattedValue += '/' + value.substring(4, 8);
            }
            input.value = formattedValue;
            // Pula para o próximo campo após preencher 8 dígitos (DD/MM/AAAA)
            if (value.length === 8) {
                let nextField;
                if (tabContext === 'agente') {
                    nextField = document.getElementById('historico');
                } else {
                    // aba tecnico
                    nextField = document.getElementById('cadUnico_tecnico'); // Novo foco
                }
                if (nextField) {
                    nextField.focus();
                }
            }
        }

        function calcularIdade(tabContext = 'agente') {
            const dataNascimentoInput = tabContext === 'agente' ? getElementByIdForActiveTab('dataNascimento') : getElementByIdForActiveTab('dataNascimento', false);
            const idadeInput = tabContext === 'agente' ? getElementByIdForActiveTab('idade') : getElementByIdForActiveTab('idade', false);

            const nascimentoStr = dataNascimentoInput.value;
            if (!nascimentoStr || nascimentoStr.length !== 10 || !nascimentoStr.includes('/')) {
                idadeInput.value = '';
                return;
            }

            const partes = nascimentoStr.split('/');
            if (partes.length !== 3) {
                idadeInput.value = '';
                return;
            }

            const nascFormatado = `${partes[2]}-${partes[1]}-${partes[0]}`;
            const nasc = new Date(nascFormatado);

            if (isNaN(nasc.getTime())) {
                idadeInput.value = '';
                return;
            }

            const hoje = new Date();
            let anos = hoje.getFullYear() - nasc.getFullYear();
            let meses = hoje.getMonth() - nasc.getMonth();
            let dias = hoje.getDate() - nasc.getDate();

            if (dias < 0) {
                meses--;
                dias += new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
            }

            if (meses < 0) {
                anos--;
                meses += 12;
            }

            let idadeTexto = `${anos} anos`;
            if (meses > 0) idadeTexto += `, ${meses} meses`;
            if (dias > 0) idadeTexto += `, ${dias} dias`;

            idadeInput.value = idadeTexto;
        }

        function atualizarContador(fieldContext = 'historico') {
            let inputElement;
            let counterElement;
            if (fieldContext === 'agente') {
                inputElement = getElementByIdForActiveTab('historico');
                counterElement = getElementByIdForActiveTab('contador');
            } else if (fieldContext === 'tecnico') {
                inputElement = getElementByIdForActiveTab('historico', false);
                counterElement = getElementByIdForActiveTab('contador', false);
            } else if (fieldContext === 'relatorioEncaminhamento') {
                // NOVO CONTEXTO
                inputElement = getElementByIdForActiveTab('relatorioEncaminhamento', false);
                counterElement = getElementByIdForActiveTab('contadorRelatorioEncaminhamento', false);
            }
            if (inputElement && counterElement) {
                const currentLength = inputElement.value.length;
                const maxLength = inputElement.maxLength;
                counterElement.innerText = `${currentLength} / ${maxLength}`;
            }
        }

        // NOVO: Função para verificar se o Relatório de Encaminhamento deve ser preenchido
        function checkDemandasTecnico() {
            const checkboxes = document.querySelectorAll('input[name="demandas_tecnico"]');
            const relatorioEncaminhamento = getElementByIdForActiveTab('relatorioEncaminhamento', false);
            let anyChecked = false;
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    anyChecked = true;
                }
            });
            // O campo não fica disabled, mas a validação ocorrerá ao gerar o PDF
            // relatorioEncaminhamento.required = anyChecked; // Descomente se quiser usar o 'required' do HTML
            // Opcionalmente, pode-se adicionar uma classe para estilizar o campo como obrigatório visualmente
            if (anyChecked) {
                relatorioEncaminhamento.classList.add('required-field-visual');
            } else {
                relatorioEncaminhamento.classList.remove('required-field-visual');
            }
        }
        
        // --- Funções para a Câmera Principal (fotos do usuário) ---
        async function tirarFoto(tabContext = 'global') {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            // const cameraMessage = document.getElementById('cameraMessage'); // Removido

            if (cameraStream) {
                // Se a câmera já está ativa, tira a foto
                capturarImagem(activeTab);
            } else {
                // Inicia a câmera
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    captureBtn.style.display = 'block';
                    stopCameraBtn.style.display = 'block';
                    // cameraMessage.style.display = 'block'; // Removido
                    cameraStream = stream;
                } catch (err) {
                    console.error("Erro ao acessar a câmera: ", err);
                    alert("Não foi possível acessar a câmera. Verifique as permissões.");
                }
            }
        }

        function capturarImagem(tabContext) {
            const activeData = getActiveData();
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const fotoData = canvas.toDataURL('image/jpeg', 0.8); // Qualidade da imagem
            activeData.fotos.push(fotoData);

            // Adiciona a miniatura na visualização
            const previewContainer = getElementByIdForActiveTab('fotosPreview');
            const fotoContainer = document.createElement('div');
            fotoContainer.className = 'foto-container';

            const img = document.createElement('img');
            img.src = fotoData;
            img.className = 'foto-thumb';
            fotoContainer.appendChild(img);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = () => removerFoto(fotoContainer, fotoData, activeTab);
            fotoContainer.appendChild(removeBtn);

            previewContainer.appendChild(fotoContainer);
            
            // Para feedback visual
            const flash = document.createElement('div');
            flash.style = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: white; opacity: 1; transition: opacity 0.1s;';
            document.body.appendChild(flash);
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(flash);
                }, 100);
            }, 50);
        }

        function removerFoto(fotoElement, fotoData, tabContext) {
            const activeData = getActiveData();
            const index = activeData.fotos.indexOf(fotoData);
            if (index > -1) {
                activeData.fotos.splice(index, 1);
            }
            fotoElement.remove();
        }

        function pararCamera(tabContext) {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            // const cameraMessage = document.getElementById('cameraMessage'); // Removido
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cameraStream = null;
                video.style.display = 'none';
                captureBtn.style.display = 'none';
                stopCameraBtn.style.display = 'none';
                // cameraMessage.style.display = 'none'; // Removido
            }
        }

        // --- Funções para Coletar GPS e Endereço ---
        function coletarGPS() {
            if ("geolocation" in navigator) {
                getElementByIdForActiveTab('gps').innerText = "Coletando localização...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const activeData = getActiveData();
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        activeData.coordenadas = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
                        getElementByIdForActiveTab('gps').innerText = activeData.coordenadas;
                        
                        // Busca o endereço com base nas coordenadas
                        buscarEndereco(lat, lon);
                    },
                    (error) => {
                        console.error("Erro ao obter a localização: ", error);
                        getElementByIdForActiveTab('gps').innerText = "Erro ao obter a localização. Verifique as permissões.";
                    }
                );
            } else {
                alert("Geolocalização não é suportada por este navegador.");
            }
        }

        function buscarEndereco(lat, lon) {
            const activeData = getActiveData();
            // Usando a API de geocodificação reversa do Google Maps
            const apiKey = 'SUA_CHAVE_DE_API_DO_GOOGLE'; // Substitua pela sua chave de API
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const enderecoCompleto = data.results[0].formatted_address;
                        getElementByIdForActiveTab('endereco').value = enderecoCompleto;
                        activeData.enderecoBaseDetalhes = extrairComponentesDoEndereco(data.results[0].address_components);
                        // Chama a atualização para garantir que o endereço completo seja exibido
                        atualizarEnderecoCompleto();
                    } else {
                        getElementByIdForActiveTab('endereco').value = "Endereço não encontrado.";
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar endereço: ", error);
                    getElementByIdForActiveTab('endereco').value = "Erro ao buscar endereço.";
                });
        }
        
        function extrairComponentesDoEndereco(components) {
            const detalhes = {};
            components.forEach(component => {
                if (component.types.includes('route')) {
                    detalhes.rua = component.long_name;
                } else if (component.types.includes('political')) {
                    detalhes.cidade = component.long_name;
                } else if (component.types.includes('administrative_area_level_2')) {
                    detalhes.bairro = component.long_name;
                } else if (component.types.includes('postal_code')) {
                    detalhes.cep = component.long_name;
                } else if (component.types.includes('country')) {
                    detalhes.pais = component.long_name;
                }
            });
            return detalhes;
        }

        function atualizarEnderecoCompleto(tabContext = '') {
            const activeData = getActiveData();
            const numero = getElementByIdForActiveTab('numero', tabContext === '').value;
            const complemento = getElementByIdForActiveTab('complemento', tabContext === '').value;
            
            let novoEndereco = getElementByIdForActiveTab('endereco', tabContext === '').value;

            // Se o campo de endereço automático já foi preenchido, apenas ajusta
            if (activeData.enderecoBaseDetalhes.rua) {
                let enderecoManual = '';
                if (numero) enderecoManual += `, Nº ${numero}`;
                if (complemento) enderecoManual += `, Complemento: ${complemento}`;
                
                novoEndereco = `${activeData.enderecoBaseDetalhes.rua}, ${activeData.enderecoBaseDetalhes.bairro}, ${activeData.enderecoBaseDetalhes.cidade}${enderecoManual}`;
            }

            getElementByIdForActiveTab('endereco', tabContext === '').value = novoEndereco;
        }

        // --- Gerar PDF e salvar no Firestore ---
        async function gerarPDF() {
            const activeData = getActiveData();
            
            // Validação de campos obrigatórios
            const camposObrigatorios = ['nome', 'nomeAgente', 'telefoneAgente', 'endereco', 'dataNascimento', 'historico'];
            if (activeTab === 'tecnico') {
                camposObrigatorios.push('cadUnico', 'bolsaFamilia', 'centroRecuperacao');
                const demandasTecnicoChecked = document.querySelectorAll('input[name="demandas_tecnico"]:checked').length > 0;
                const relatorioEncaminhamento = getElementByIdForActiveTab('relatorioEncaminhamento', false).value.trim();
                if (demandasTecnicoChecked && !relatorioEncaminhamento) {
                    alert('Por favor, preencha o Relatório de Encaminhamento, pois uma ou mais demandas foram selecionadas.');
                    return;
                }
            }
            
            let formValido = true;
            for (const campo of camposObrigatorios) {
                const elemento = getElementByIdForActiveTab(campo);
                if (elemento && elemento.value.trim() === '') {
                    formValido = false;
                    elemento.style.border = '2px solid var(--red-color)';
                    setTimeout(() => elemento.style.border = '1px solid var(--border-color)', 2000);
                } else if (elemento) {
                    elemento.style.border = '1px solid var(--border-color)';
                }
            }

            if (!formValido) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Selecionar demandas
            const demandasSelecionadas = [];
            const demandaCheckboxes = document.querySelectorAll(`input[name="demandas${activeTab === 'tecnico' ? '_tecnico' : ''}"]:checked`);
            demandaCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'Outros' && getElementByIdForActiveTab('outrosDemandaInput', activeTab === 'tecnico').value.trim() !== '') {
                    demandasSelecionadas.push(`Outros: ${getElementByIdForActiveTab('outrosDemandaInput', activeTab === 'tecnico').value.trim()}`);
                } else if (checkbox.value !== 'Outros') {
                    demandasSelecionadas.push(checkbox.value);
                }
            });

            // Novo: Salvar os dados no Firestore antes de gerar o PDF
            const currentTabSuffix = activeTab === 'agenteCampo' ? '' : '_tecnico';

            const dadosParaSalvar = {
                codigoAtendimento: activeData.codigoAtual,
                dataHora: firebase.firestore.FieldValue.serverTimestamp(),
                tipoRelatorio: activeTab === 'agenteCampo' ? 'Agente de Campo' : 'Técnico',
                agenteResponsavel: getElementByIdForActiveTab('nomeAgente').value,
                telefoneAgente: getElementByIdForActiveTab('telefoneAgente').value,
                nomeUsuario: getElementByIdForActiveTab('nome').value,
                identidade: getElementByIdForActiveTab('identidade').value,
                cpf: getElementByIdForActiveTab('cpf').value,
                endereco: getElementByIdForActiveTab('endereco').value,
                dataNascimento: getElementByIdForActiveTab('dataNascimento').value,
                idade: getElementByIdForActiveTab('idade').value,
                historico: getElementByIdForActiveTab('historico').value,
                demandas: demandasSelecionadas,
                coordenadas: activeData.coordenadas,
                cadUnico: activeTab === 'tecnico' ? getElementByIdForActiveTab('cadUnico', false).value : null,
                bolsaFamilia: activeTab === 'tecnico' ? getElementByIdForActiveTab('bolsaFamilia', false).value : null,
                centroRecuperacao: activeTab === 'tecnico' ? getElementByIdForActiveTab('centroRecuperacao', false).value : null,
                relatorioEncaminhamento: activeTab === 'tecnico' ? getElementByIdForActiveTab('relatorioEncaminhamento', false).value : null,
                atendimentoPsicossocial: activeTab === 'tecnico' ? getElementByIdForActiveTab('atendimentoPsicossocial', false).checked : false,
            };

            // Salvar fotos no Firebase Storage e obter as URLs
            const fotoUrls = [];
            for (let i = 0; i < activeData.fotos.length; i++) {
                const fotoBase64 = activeData.fotos[i];
                const storageRef = storage.ref(`relatorios/${activeData.codigoAtual}/foto_${i+1}.jpeg`);
                await storageRef.putString(fotoBase64, 'data_url');
                const url = await storageRef.getDownloadURL();
                fotoUrls.push(url);
            }
            dadosParaSalvar.fotoUrls = fotoUrls;

            try {
                // Salvar o documento na coleção 'relatorios' com o código de atendimento como ID
                await db.collection("relatorios").doc(activeData.codigoAtual).set(dadosParaSalvar);
                console.log("Documento salvo com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar documento: ", e);
                alert("Ocorreu um erro ao salvar o relatório no banco de dados. Por favor, tente novamente.");
                return; // Impede a geração do PDF se o salvamento falhar
            }
            

            // Início da geração do PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            addCustomFont(doc);
            doc.setFont('helvetica');

            let yPos = 10;
            doc.setFontSize(16);
            doc.setTextColor(52, 58, 64);
            doc.text(`Relatório de Atendimento - ${dadosParaSalvar.tipoRelatorio}`, 105, yPos, null, null, "center");
            yPos += 10;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125);
            doc.text(`Relatório nº: ${activeData.codigoAtual}`, 105, yPos, null, null, "center");
            doc.text(`Data/Hora: ${new Date().toLocaleString()}`, 105, yPos + 5, null, null, "center");
            yPos += 15;

            // Dados do Agente/Técnico
            doc.setFontSize(12);
            doc.setTextColor(52, 58, 64);
            doc.text('Dados do Responsável:', 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125);
            doc.text(`Nome: ${dadosParaSalvar.agenteResponsavel}`, 15, yPos);
            doc.text(`Telefone: ${dadosParaSalvar.telefoneAgente}`, 105, yPos);
            yPos += 10;

            // Dados do Usuário
            doc.setFontSize(12);
            doc.setTextColor(52, 58, 64);
            doc.text('Dados do Usuário:', 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125);
            doc.text(`Nome: ${dadosParaSalvar.nomeUsuario}`, 15, yPos);
            yPos += 5;
            doc.text(`Identidade: ${dadosParaSalvar.identidade}`, 15, yPos);
            doc.text(`CPF: ${dadosParaSalvar.cpf}`, 105, yPos);
            yPos += 5;
            doc.text(`Endereço: ${dadosParaSalvar.endereco}`, 15, yPos);
            yPos += 5;
            doc.text(`Data de Nasc.: ${dadosParaSalvar.dataNascimento}`, 15, yPos);
            doc.text(`Idade: ${dadosParaSalvar.idade}`, 105, yPos);
            yPos += 10;
            
            // Dados específicos do Técnico
            if (activeTab === 'tecnico') {
                doc.setFontSize(12);
                doc.setTextColor(52, 58, 64);
                doc.text('Informações Adicionais:', 15, yPos);
                yPos += 7;
                doc.setFontSize(10);
                doc.setTextColor(108, 117, 125);
                doc.text(`CAD Único: ${dadosParaSalvar.cadUnico}`, 15, yPos);
                doc.text(`Bolsa-Família: ${dadosParaSalvar.bolsaFamilia}`, 70, yPos);
                doc.text(`Centro de Recup.: ${dadosParaSalvar.centroRecuperacao}`, 135, yPos);
                yPos += 5;
                doc.text(`Atendimento Psicossocial: ${dadosParaSalvar.atendimentoPsicossocial ? 'Sim' : 'Não'}`, 15, yPos);
                yPos += 10;
            }

            // Histórico do Usuário
            doc.setFontSize(12);
            doc.setTextColor(52, 58, 64);
            doc.text('Histórico do Usuário:', 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125);
            const historicoLines = doc.splitTextToSize(dadosParaSalvar.historico, 180);
            doc.text(historicoLines, 15, yPos);
            yPos += historicoLines.length * 5 + 5;

            // Relatório de Encaminhamento (se for técnico e houver)
            if (activeTab === 'tecnico' && dadosParaSalvar.relatorioEncaminhamento) {
                doc.setFontSize(12);
                doc.setTextColor(52, 58, 64);
                doc.text('Relatório de Encaminhamento:', 15, yPos);
                yPos += 7;
                doc.setFontSize(10);
                doc.setTextColor(108, 117, 125);
                const relatorioLines = doc.splitTextToSize(dadosParaSalvar.relatorioEncaminhamento, 180);
                doc.text(relatorioLines, 15, yPos);
                yPos += relatorioLines.length * 5 + 5;
            }

            // Demandas
            doc.setFontSize(12);
            doc.setTextColor(52, 58, 64);
            doc.text('Demandas:', 15, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125);
            const demandasText = demandasSelecionadas.length > 0 ? demandasSelecionadas.join(', ') : 'Nenhuma demanda selecionada.';
            const demandasLines = doc.splitTextToSize(demandasText, 180);
            doc.text(demandasLines, 15, yPos);
            yPos += demandasLines.length * 5 + 5;

            // Fotos (se houver)
            if (fotoUrls.length > 0) {
                doc.addPage();
                yPos = 15;
                doc.setFontSize(12);
                doc.setTextColor(52, 58, 64);
                doc.text('Fotos do Atendimento:', 15, yPos);
                yPos += 10;
                
                const imgWidth = 80;
                const imgHeight = 60;
                const margin = 15;
                const spacing = 10;
                const imagesPerRow = Math.floor((doc.internal.pageSize.width - 2 * margin) / (imgWidth + spacing));
                
                let xPos = margin;
                let yPosInitial = yPos;

                for (let i = 0; i < fotoUrls.length; i++) {
                    // Adiciona quebra de página se não houver espaço
                    if (yPos + imgHeight > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        yPos = margin;
                        yPosInitial = yPos;
                        xPos = margin;
                    }
                    
                    const img = new Image();
                    img.src = activeData.fotos[i];
                    doc.addImage(img, 'JPEG', xPos, yPos, imgWidth, imgHeight);

                    xPos += imgWidth + spacing;
                    if ((i + 1) % imagesPerRow === 0) {
                        xPos = margin;
                        yPos += imgHeight + spacing;
                    }
                }
            }


            // Salva o PDF
            activeData.pdfFileName = `Relatorio_${activeData.codigoAtual}.pdf`;
            activeData.pdfDataUri = doc.output('datauristring');
            
            // Habilita o botão do WhatsApp
            document.getElementById('btnEnviarWhatsApp').disabled = false;
            
            // Salva o PDF no navegador
            doc.save(activeData.pdfFileName);

        }

        // --- Enviar via WhatsApp ---
        function enviarWhatsApp() {
            const activeData = getActiveData();

            if (!activeData.pdfDataUri) {
                alert("Por favor, gere o PDF primeiro.");
                return;
            }

            const fileName = activeData.pdfFileName;
            const fileData = activeData.pdfDataUri.split(',')[1];
            
            // Esta funcionalidade requer uma implementação mais robusta de compartilhamento de arquivos
            // via web, que pode não funcionar em todos os navegadores.
            // Para web, uma abordagem melhor seria um backend para enviar o arquivo.
            // Para apps nativos, a funcionalidade é mais simples.
            // Aqui, apenas tentamos um link genérico, que pode não funcionar.
            
            alert("A funcionalidade de envio via WhatsApp não é suportada diretamente em todos os navegadores para arquivos. Salve o arquivo PDF e anexe-o manualmente na conversa.");

            // A próxima linha é um exemplo de como poderia ser feito em um ambiente com suporte.
            // window.open(`whatsapp://send?text=Segue o relatório em anexo: ${fileName}`);
        }
        
        function limparFormulario() {
            if (confirm("Tem certeza que deseja limpar todo o formulário?")) {
                const activeData = getActiveData();
                const activeDataPrefix = activeTab === 'agenteCampo' ? '' : '_tecnico';

                // Limpar campos de texto e textareas
                document.querySelectorAll(`#${activeTab} input[type="text"], #${activeTab} input[type="tel"], #${activeTab} textarea`).forEach(input => {
                    input.value = '';
                    input.style.border = '1px solid var(--border-color)';
                    input.disabled = false;
                });
                // Limpar select
                document.querySelectorAll(`#${activeTab} select`).forEach(select => {
                    select.selectedIndex = 0;
                });
                // Limpar checkboxes
                document.querySelectorAll(`#${activeTab} input[type="checkbox"]`).forEach(checkbox => {
                    checkbox.checked = false;
                });
                // Esconder campos condicionais
                getElementByIdForActiveTab('outrosDemandaContainer', activeDataPrefix !== '').style.display = 'none';

                // Limpar dados na memória
                activeData.fotos = [];
                activeData.coordenadas = "";
                activeData.pdfDataUri = null;
                activeData.agenteDadosPreenchidos = false;

                // Limpar previews
                getElementByIdForActiveTab('fotosPreview').innerHTML = '';
                getElementByIdForActiveTab('gps').innerText = '';

                // Resetar contadores
                atualizarContador('historico');
                if (activeTab === 'tecnico') {
                     atualizarContador('relatorioEncaminhamento');
                     checkDemandasTecnico(); // Para remover a classe de campo obrigatório visual
                }

                // Parar a câmera se estiver ativa
                pararCamera('global');

                // Recriar código de atendimento
                gerarCodigoAtendimento();

                // Desabilitar o botão do WhatsApp
                document.getElementById('btnEnviarWhatsApp').disabled = true;
                
                alert("Formulário limpo com sucesso!");
            }
        }
    </script>
</body>
</html>