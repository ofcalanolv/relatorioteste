<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Cadastro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; /* Remove default body margin */
            background: #f5f5f5; 
            padding-bottom: 70px; /* Add padding for the fixed taskbar */
        }
        h2, h3 { text-align: center; }
        .container { 
            max-width: 500px; 
            margin: 10px auto; /* Adjust margin-top for tabs */
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; /* Space above the taskbar */
        }
        input, textarea { 
            display: block; 
            margin: 10px 0; 
            padding: 10px; 
            width: 100%; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 16px; 
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* Style for disabled inputs and buttons */
        input:disabled, textarea:disabled, button:disabled {
            background-color: #e9e9e9;
            color: #555;
            cursor: not-allowed;
            opacity: 0.7; /* Make disabled buttons slightly faded */
        }
        .inline-fields { display: flex; gap: 10px; }
        .inline-fields input { flex: 1; }
        #fotosPreview, #fotosDocumentoPreview { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .foto-container { position: relative; display: inline-block; }
        .foto-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
        .remove-btn { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            font-size: 14px; 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        #gps { font-size: 14px; color: #555; }
        #contador { font-size: 12px; text-align: right; color: #555; margin-top: -8px; }
        #codigoDisplay, #codigoDisplayTecnico { font-size: 14px; font-weight: bold; text-align: center; margin-top: 10px; color: #333; }
        #mapPreview {
            width: 100%;
            height: 150px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            margin-top: 10px;
            display: none; /* Hidden by default */
            object-fit: cover;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .camera-controls button {
            flex: 1;
            margin: 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer;
        }
        .camera-controls button:hover { background: #0056b3; }

        /* Taskbar Styles */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 1000; /* Ensure it stays on top */
        }
        .taskbar button {
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
            flex: 1; /* Distribute space evenly */
            margin: 0 2px; /* Small margin between buttons */
        }
        .taskbar button:not(:disabled):hover { /* Apply hover only when not disabled */
            background: #555;
        }
        .taskbar button i {
            font-size: 24px; /* Icon size */
        }
        .taskbar button span {
            font-size: 10px; /* Label size */
            white-space: nowrap; /* Keep label on one line */
        }
        
        /* Specific button colors */
        #btnColetarGPS { background: #007bff; }
        #btnColetarGPS:not(:disabled):hover { background: #0056b3; }
        #btnTirarFoto { background: #28a745; }
        #btnTirarFoto:not(:disabled):hover { background: #218838; }
        #btnGerarPDF { background: #ffc107; color: #333; } /* Adjusted color for visibility */
        #btnGerarPDF:not(:disabled):hover { background: #e0a800; }
        #btnLimparFormulario { background: #dc3545; }
        #btnLimparFormulario:not(:disabled):hover { background: #c82333; }
        #btnEnviarWhatsApp { background: #25d366; } /* WhatsApp green, always visible */
        #btnEnviarWhatsApp:not(:disabled):hover { background: #1da851; }


        @media (max-width: 600px) {
            .inline-fields { flex-direction: column; }
            .camera-controls { flex-direction: column; }
            .taskbar button {
                padding: 5px 5px; /* Adjust padding for smaller screens */
            }
            .taskbar button i {
                font-size: 20px; /* Smaller icons on small screens */
            }
            .taskbar button span {
                font-size: 9px; /* Smaller labels on small screens */
            }
        }

        /* Checkbox demands styling */
        .demand-group {
            margin-top: 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .demand-group h3 {
            margin-top: 0;
            text-align: left;
            margin-bottom: 10px;
        }
        /* Flexbox for side-by-side checkboxes */
        .demand-items-container {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            gap: 15px; /* Space between items */
            justify-content: flex-start; /* Align items to the start */
        }
        .demand-item {
            display: flex;
            align-items: center;
        }
        .demand-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px; /* Slightly less margin for tighter fit */
            transform: scale(1.2); /* Make checkboxes slightly larger */
        }
        .demand-item label {
            font-size: 16px;
            cursor: pointer;
            white-space: nowrap; /* Keep label on one line */
        }
        #outrosDemandaContainer, #outrosDemandaContainerTecnico {
            margin-top: 10px;
            width: 100%; /* Take full width below other checkboxes */
        }
        #outrosDemandaInput, #outrosDemandaInputTecnico {
            margin-top: 5px;
            width: calc(100% - 20px); /* Adjust for padding */
            display: block;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            justify-content: center;
            background: #eee;
            padding: 0;
            margin-top: 0; /* Align with top of body */
            border-bottom: 1px solid #ccc;
        }
        .tab-button {
            flex: 1; /* Distribute space evenly */
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            font-size: 18px;
            color: #555;
            transition: background 0.3s, color 0.3s;
            border-bottom: 3px solid transparent; /* For active indicator */
            text-align: center;
        }
        .tab-button:hover {
            background: #e0e0e0;
        }
        .tab-button.active {
            background: #fff;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            display: none; /* Hidden by default */
            /* Add some padding if needed, but container already has it */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
        }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('agenteCampo')">Agente de Campo</button>
        <button class="tab-button" onclick="showTab('tecnico')">Técnico</button>
    </div>

    <div id="agenteCampo" class="tab-content active">
        <div class="container" id="appContainerAgente">
            <h2>Cadastro de Usuário - Agente de Campo</h2>
            <div id="codigoDisplay"></div>
            
            <input type="text" id="nomeAgente" placeholder="Nome do Agente Responsável">
            <input type="tel" id="telefoneAgente" placeholder="Telefone do Agente Responsável" inputmode="numeric" pattern="[0-9]*">

            <input type="text" id="nome" placeholder="Nome do Usuário">
            <input type="text" id="identidade" placeholder="Identidade">
            <input type="tel" id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'agente')">

            <input type="text" id="endereco" placeholder="Endereço (coletado automaticamente)" readonly>
            <div class="inline-fields">
                <input type="text" id="numero" placeholder="Número" oninput="atualizarEnderecoCompleto()">
                <input type="text" id="complemento" placeholder="Complemento" oninput="atualizarEnderecoCompleto()">
            </div>
            <img id="mapPreview" alt="Mapa da Localização">

            <input type="tel" id="dataNascimento" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'agente')" onchange="calcularIdade('agente')">
            <input type="text" id="idade" placeholder="Idade" readonly>

            <textarea id="historico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador()"></textarea>
            <div id="contador">0 / 5000</div>

            <div class="demand-group">
                <h3>Demandas:</h3>
                <div class="demand-items-container"> 
                    <div class="demand-item">
                        <input type="checkbox" id="demandaBanho" name="demandas" value="Banho">
                        <label for="demandaBanho">Banho</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAssistenteSocial" name="demandas" value="Assistente Social">
                        <label for="demandaAssistenteSocial">Assistente Social</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaPsicologo" name="demandas" value="Psicólogo">
                        <label for="demandaPsicologo">Psicólogo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaEncaminhamento" name="demandas" value="Encaminhamento">
                        <label for="demandaEncaminhamento">Encaminhamento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAcolhimento" name="demandas" value="Acolhimento">
                        <label for="demandaAcolhimento">Acolhimento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaDuvidas" name="demandas" value="Dúvidas">
                        <label for="demandaDuvidas">Dúvidas</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaInformacoes" name="demandas" value="Informações">
                        <label for="demandaInformacoes">Informações</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaCorteCabelo" name="demandas" value="Corte de cabelo">
                        <label for="demandaCabelo">Corte de cabelo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaOutros" name="demandas" value="Outros">
                        <label for="demandaOutros">Outros</label>
                    </div>
                </div> 
                <div id="outrosDemandaContainer" style="display:none;">
                    <input type="text" id="outrosDemandaInput" placeholder="Especifique outras demandas">
                </div>
            </div>

            <video id="video" width="100%" autoplay style="display:none;" playsinline></video>
            <div class="camera-controls">
                <button id="captureBtn" style="display:none;" onclick="capturarImagem('agente')">Capturar Imagem</button>
                <button id="stopCameraBtn" style="display:none; background: #dc3545;" onclick="pararCamera('agente')">Fechar Câmera</button>
            </div>
            <div id="fotosPreview"></div>

            <p id="gps"></p>
        </div>
    </div>

    <div id="tecnico" class="tab-content">
        <div class="container" id="appContainerTecnico">
            <h2>Cadastro de Usuário - Técnico</h2>
            <div id="codigoDisplayTecnico"></div>
            
            <input type="text" id="nomeTecnico" placeholder="Nome do Técnico Responsável">
            <input type="tel" id="telefoneTecnico" placeholder="Telefone do Técnico Responsável" inputmode="numeric" pattern="[0-9]*">

            <input type="text" id="nome_tecnico" placeholder="Nome do Usuário">
            <input type="text" id="identidade_tecnico" placeholder="Identidade">
            <input type="tel" id="cpf_tecnico" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" oninput="formatarCPF(this, 'tecnico')">

            <input type="text" id="endereco_tecnico" placeholder="Endereço (coletado automaticamente)" readonly>
            <div class="inline-fields">
                <input type="text" id="numero_tecnico" placeholder="Número" oninput="atualizarEnderecoCompleto('tecnico')">
                <input type="text" id="complemento_tecnico" placeholder="Complemento" oninput="atualizarEnderecoCompleto('tecnico')">
            </div>
            <div id="mapPreviewTecnico" style="display:none;"></div> <input type="tel" id="dataNascimento_tecnico" placeholder="DD/MM/AAAA" inputmode="numeric" pattern="[0-9/]*" oninput="formatarDataNascimento(this, 'tecnico')" onchange="calcularIdade('tecnico')">
            <input type="text" id="idade_tecnico" placeholder="Idade" readonly>

            <textarea id="historico_tecnico" placeholder="Histórico do Usuário (até 5000 caracteres)" maxlength="5000" rows="6" oninput="atualizarContador('tecnico')"></textarea>
            <div id="contadorTecnico">0 / 5000</div>

            <div class="demand-group">
                <h3>Demandas:</h3>
                <div class="demand-items-container"> 
                    <div class="demand-item">
                        <input type="checkbox" id="demandaBanho_tecnico" name="demandas_tecnico" value="Banho">
                        <label for="demandaBanho_tecnico">Banho</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAssistenteSocial_tecnico" name="demandas_tecnico" value="Assistente Social">
                        <label for="demandaAssistenteSocial_tecnico">Assistente Social</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaPsicologo_tecnico" name="demandas_tecnico" value="Psicólogo">
                        <label for="demandaPsicologo_tecnico">Psicólogo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaEncaminhamento_tecnico" name="demandas_tecnico" value="Encaminhamento">
                        <label for="demandaEncaminhamento_tecnico">Encaminhamento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaAcolhimento_tecnico" name="demandas_tecnico" value="Acolhimento">
                        <label for="demandaAcolhimento_tecnico">Acolhimento</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaDuvidas_tecnico" name="demandas_tecnico" value="Dúvidas">
                        <label for="demandaDuvidas_tecnico">Dúvidas</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaInformacoes_tecnico" name="demandas_tecnico" value="Informações">
                        <label for="demandaInformacoes_tecnico">Informações</label> 
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaCorteCabelo_tecnico" name="demandas_tecnico" value="Corte de cabelo">
                        <label for="demandaCabelo_tecnico">Corte de cabelo</label>
                    </div>
                    <div class="demand-item">
                        <input type="checkbox" id="demandaOutros_tecnico" name="demandas_tecnico" value="Outros">
                        <label for="demandaOutros_tecnico">Outros</label>
                    </div>
                </div> 
                <div id="outrosDemandaContainerTecnico" style="display:none;">
                    <input type="text" id="outrosDemandaInputTecnico" placeholder="Especifique outras demandas">
                </div>
            </div>

            <div id="fotosPreviewTecnico"></div>

            <p id="gpsTecnico"></p>
        </div>
    </div>


    <div class="taskbar" id="mainTaskbar">
        <button id="btnColetarGPS" onclick="coletarGPS()">
            <i class="fas fa-map-marker-alt"></i>
            <span>Endereço</span>
        </button>
        <button id="btnTirarFoto" onclick="tirarFoto('global')">
            <i class="fas fa-camera"></i>
            <span>Foto</span>
        </button>
        <button id="btnGerarPDF" onclick="gerarPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>Gerar PDF</span>
        </button>
        <button id="btnLimparFormulario" onclick="limparFormulario()">
            <i class="fas fa-broom"></i>
            <span>Limpar</span>
        </button>
         <button id="btnEnviarWhatsApp" onclick="enviarWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
        </button>
    </div>

    <script>
        // Remova ou substitua esta chave com a sua chave real do Google Maps API
        const Maps_API_KEY = "AIzaSyATdDuH-ptUpN_UsZpotGX4Xe83AvUVF-E"; 

        // Dados para Agente de Campo
        let dadosAgenteCampo = {
            fotos: [], // Fotos do usuário
            coordenadas: "",
            enderecoBaseDetalhes: {},
            codigoAtual: "",
            mapImageUrl: "", 
            pdfDataUri: null, 
            pdfFileName: "",
            agenteDadosPreenchidos: false,
            // Adicione mais campos aqui se precisar de dados separados para cada aba
            nomeAgente: "",
            telefoneAgente: "",
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            historico: "",
            demandas: []
        };

        // Dados para Técnico (inicialmente duplicados para teste)
        let dadosTecnico = {
            fotos: [], 
            coordenadas: "",
            enderecoBaseDetalhes: {},
            codigoAtual: "",
            mapImageUrl: "", 
            pdfDataUri: null, 
            pdfFileName: "",
            agenteDadosPreenchidos: false, // Pode ser renomeado para 'tecnicoDadosPreenchidos'
            // IDs de campos da aba Técnico devem ser atualizados para pegar seus próprios valores
            nomeAgente: "", // Isso será nomeTecnico
            telefoneAgente: "", // Isso será telefoneTecnico
            nomeUsuario: "",
            identidade: "",
            cpf: "",
            endereco: "",
            numero: "",
            complemento: "",
            dataNascimento: "",
            idade: "",
            historico: "",
            demandas: []
        };

        let activeTab = 'agenteCampo'; // Controla qual aba está ativa
        let cameraStream = null; // Stream da câmera principal

        const addCustomFont = (doc) => {
            doc.addFont('helvetica', 'normal', 'normal');
        };

        function getActiveData() {
            return activeTab === 'agenteCampo' ? dadosAgenteCampo : dadosTecnico;
        }

        function getElementByIdForActiveTab(idBase, forElement = true) {
            if (activeTab === 'agenteCampo') {
                return document.getElementById(idBase);
            } else {
                // IDs para aba técnico
                if (idBase === 'codigoDisplay') return document.getElementById('codigoDisplayTecnico');
                if (idBase === 'nomeAgente') return document.getElementById('nomeTecnico');
                if (idBase === 'telefoneAgente') return document.getElementById('telefoneTecnico');
                if (idBase === 'nome') return document.getElementById('nome_tecnico');
                if (idBase === 'identidade') return document.getElementById('identidade_tecnico');
                if (idBase === 'cpf') return document.getElementById('cpf_tecnico');
                if (idBase === 'endereco') return document.getElementById('endereco_tecnico');
                if (idBase === 'numero') return document.getElementById('numero_tecnico');
                if (idBase === 'complemento') return document.getElementById('complemento_tecnico');
                if (idBase === 'dataNascimento') return document.getElementById('dataNascimento_tecnico');
                if (idBase === 'idade') return document.getElementById('idade_tecnico');
                if (idBase === 'historico') return document.getElementById('historico_tecnico');
                if (idBase === 'contador') return document.getElementById('contadorTecnico');
                if (idBase === 'demandaOutros') return document.getElementById('demandaOutros_tecnico');
                if (idBase === 'outrosDemandaContainer') return document.getElementById('outrosDemandaContainerTecnico');
                if (idBase === 'outrosDemandaInput') return document.getElementById('outrosDemandaInputTecnico');
                if (idBase === 'fotosPreview') return document.getElementById('fotosPreviewTecnico');
                if (idBase === 'gps') return document.getElementById('gpsTecnico');
                // Campos de camera e mapPreview são compartilhados no HTML
                if (idBase === 'video' || idBase === 'captureBtn' || idBase === 'stopCameraBtn' ||
                    idBase === 'mapPreview') {
                    return document.getElementById(idBase);
                }
                
                // Para checkboxes, o 'name' é diferente
                if (idBase === 'demandas') {
                    return document.querySelectorAll(`input[name="demandas_tecnico"]`);
                } else if (forElement) { // Default para outros elementos
                    return document.getElementById(`${idBase}_tecnico`);
                }
                return null;
            }
        }


        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            activeTab = tabId; // Atualiza a aba ativa
            
            // Re-renderizar o código de atendimento e habilitar/desabilitar o botão do WhatsApp
            const activeData = getActiveData();
            gerarCodigoAtendimento(); // Gera um novo código para a aba ativa (ou exibe o existente)
            document.getElementById('btnEnviarWhatsApp').disabled = !activeData.pdfDataUri;

            // Para parar a câmera se o usuário mudar de aba com a câmera aberta
            pararCamera('global'); 
        }

        function gerarCodigoAtendimento() {
            const activeData = getActiveData();
            if (!activeData.codigoAtual) {
                const agora = new Date();
                const d = String(agora.getDate()).padStart(2, '0');
                const m = String(agora.getMonth() + 1).padStart(2, '0');
                const y = agora.getFullYear();
                const h = String(agora.getHours()).padStart(2, '0');
                const min = String(agora.getMinutes()).padStart(2, '0');
                const s = String(agora.getSeconds()).padStart(2, '0');
                activeData.codigoAtual = `${d}${m}${y}-${h}${min}${s}`;
            }
            getElementByIdForActiveTab('codigoDisplay').innerText = `Relatório nº: ${activeData.codigoAtual}`;
            return activeData.codigoAtual;
        }

        document.addEventListener('DOMContentLoaded', () => {
            gerarCodigoAtendimento();
            
            getElementByIdForActiveTab('demandaOutros').addEventListener('change', function() {
                const outrosContainer = getElementByIdForActiveTab('outrosDemandaContainer');
                outrosContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    getElementByIdForActiveTab('outrosDemandaInput').value = ''; 
                }
            });
            // Adicionar event listener para a aba Técnico também
            getElementByIdForActiveTab('demandaOutros', false).addEventListener('change', function() {
                 const outrosContainer = getElementByIdForActiveTab('outrosDemandaContainer', false);
                 outrosContainer.style.display = this.checked ? 'block' : 'none';
                 if (!this.checked) {
                     getElementByIdForActiveTab('outrosDemandaInput', false).value = '';
                 }
            });

            getElementByIdForActiveTab('telefoneAgente').addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/\D/g, ''); 
            });
            getElementByIdForActiveTab('telefoneAgente', false).addEventListener('input', function (e) { // Para aba tecnico
                 e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Adiciona listener para desabilitar campos do agente após o primeiro input
            getElementByIdForActiveTab('nomeAgente').addEventListener('blur', () => checkAndDisableAgentFields('agenteCampo'));
            getElementByIdForActiveTab('telefoneAgente').addEventListener('blur', () => checkAndDisableAgentFields('agenteCampo'));
            getElementByIdForActiveTab('nomeAgente', false).addEventListener('blur', () => checkAndDisableAgentFields('tecnico'));
            getElementByIdForActiveTab('telefoneAgente', false).addEventListener('blur', () => checkAndDisableAgentFields('tecnico'));

            // Inicia o botão do WhatsApp desabilitado
            document.getElementById('btnEnviarWhatsApp').disabled = true;

            // Exibir a primeira aba por padrão
            showTab('agenteCampo');
        });

        function checkAndDisableAgentFields(tabId) {
            const currentData = tabId === 'agenteCampo' ? dadosAgenteCampo : dadosTecnico;
            const nomeInput = document.getElementById(tabId === 'agenteCampo' ? 'nomeAgente' : 'nomeTecnico');
            const telefoneInput = document.getElementById(tabId === 'agenteCampo' ? 'telefoneAgente' : 'telefoneTecnico');

            if (nomeInput.value.trim() !== '' && telefoneInput.value.trim() !== '' && !currentData.agenteDadosPreenchidos) {
                nomeInput.disabled = true;
                telefoneInput.disabled = true;
                currentData.agenteDadosPreenchidos = true;
            }
        }


        function formatarCPF(input, tabContext) {
            let value = input.value.replace(/\D/g, ''); 
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += value.substring(0, 3);
            }
            if (value.length > 3) {
                formattedValue += '.' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formattedValue += '.' + value.substring(6, 9);
            }
            if (value.length > 9) {
                formattedValue += '-' + value.substring(9, 11);
            }
            input.value = formattedValue;

            // Pula para o próximo campo após preencher 11 dígitos
            if (value.length === 11) {
                const nextField = tabContext === 'agente' ? 
                    document.getElementById('dataNascimento') : 
                    document.getElementById('dataNascimento_tecnico');
                if (nextField) {
                    nextField.focus();
                }
            }
        }


        function formatarDataNascimento(input, tabContext) {
            let value = input.value.replace(/\D/g, ''); 
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += value.substring(0, 2);
            }
            if (value.length > 2) {
                formattedValue += '/' + value.substring(2, 4);
            }
            if (value.length > 4) {
                formattedValue += '/' + value.substring(4, 8);
            }
            input.value = formattedValue;

            // Pula para o próximo campo após preencher 8 dígitos (DD/MM/AAAA)
            if (value.length === 8) {
                const nextField = tabContext === 'agente' ? 
                    document.getElementById('historico') : 
                    document.getElementById('historico_tecnico');
                if (nextField) {
                    nextField.focus();
                }
            }
        }

        function calcularIdade(tabContext = 'agente') {
            const dataNascimentoInput = tabContext === 'agente' ? getElementByIdForActiveTab('dataNascimento') : getElementByIdForActiveTab('dataNascimento', false);
            const idadeInput = tabContext === 'agente' ? getElementByIdForActiveTab('idade') : getElementByIdForActiveTab('idade', false);
            
            const nascimentoStr = dataNascimentoInput.value;

            if (!nascimentoStr || nascimentoStr.length !== 10 || !nascimentoStr.includes('/')) {
                idadeInput.value = '';
                return;
            }

            const partes = nascimentoStr.split('/');
            if (partes.length !== 3) {
                idadeInput.value = '';
                return;
            }
            const nascFormatado = `${partes[2]}-${partes[1]}-${partes[0]}`;
            const nasc = new Date(nascFormatado);

            if (isNaN(nasc.getTime())) {
                idadeInput.value = '';
                return;
            }

            const hoje = new Date();
            
            let anos = hoje.getFullYear() - nasc.getFullYear();
            let meses = hoje.getMonth() - nasc.getMonth();
            let dias = hoje.getDate() - nasc.getDate();

            if (dias < 0) {
                meses--;
                dias += new Date(hoje.getFullYear(), hoje.getMonth(), 0).getDate();
            }
            if (meses < 0) {
                anos--;
                meses += 12;
            }

            let idadeTexto = `${anos} anos`;
            if (meses > 0) idadeTexto += `, ${meses} meses`;
            if (dias > 0) idadeTexto += `, ${dias} dias`;

            idadeInput.value = idadeTexto;
        }

        function atualizarContador(tabContext = 'agente') {
            const historicoInput = tabContext === 'agente' ? getElementByIdForActiveTab('historico') : getElementByIdForActiveTab('historico', false);
            const contadorDisplay = tabContext === 'agente' ? getElementByIdForActiveTab('contador') : getElementByIdForActiveTab('contador', false);
            
            const historico = historicoInput.value.length;
            contadorDisplay.innerText = `${historico} / 5000`;
        }


        // --- Funções para a Câmera Principal (fotos do usuário) ---
        async function tirarFoto(tabContext = 'global') {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');

            if (cameraStream && cameraStream.active) {
                video.style.display = "block";
                captureBtn.style.display = "block";
                stopCameraBtn.style.display = "block";
                return; 
            }

            try {
                video.setAttribute('playsinline', ''); 
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                video.style.display = "block";
                captureBtn.style.display = "block"; 
                stopCameraBtn.style.display = "block";
                video.play();
            } catch (err) {
                console.error("Erro ao acessar a câmera principal:", err);
                alert("Não foi possível acessar a câmera. Verifique as permissões do navegador ou se a câmera está em uso.");
                video.style.display = "none";
                captureBtn.style.display = "none";
                stopCameraBtn.style.display = "none";
            }
        }

        function pararCamera(tabContext = 'global') {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null; 
                cameraStream = null; 
                video.pause(); 
            }
            video.style.display = "none";
            captureBtn.style.display = "none";
            stopCameraBtn.style.display = "none";
        }

        function capturarImagem(tabContext = 'agente') {
            const video = document.getElementById('video');
            if (!video.srcObject) { 
                alert("Câmera não está ativa para captura.");
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const fotoBase64 = canvas.toDataURL("image/jpeg", 0.8);

            const activeData = getActiveData();
            activeData.fotos.push(fotoBase64);

            const previewDiv = getElementByIdForActiveTab('fotosPreview');
            const container = document.createElement('div');
            container.classList.add('foto-container');
            const img = document.createElement('img');
            img.src = fotoBase64;
            img.classList.add('foto-thumb');
            const removeBtn = document.createElement('button');
            removeBtn.innerText = "X";
            removeBtn.classList.add('remove-btn');
            removeBtn.onclick = () => {
                activeData.fotos = activeData.fotos.filter(f => f !== fotoBase64);
                container.remove();
            };
            container.appendChild(img);
            container.appendChild(removeBtn);
            previewDiv.appendChild(container);
        }

        function atualizarEnderecoCompleto(tabContext = 'agente') {
            const activeData = getActiveData();
            const numeroInput = tabContext === 'agente' ? getElementByIdForActiveTab('numero') : getElementByIdForActiveTab('numero', false);
            const complementoInput = tabContext === 'agente' ? getElementByIdForActiveTab('complemento') : getElementByIdForActiveTab('complemento', false);
            const enderecoInput = tabContext === 'agente' ? getElementByIdForActiveTab('endereco') : getElementByIdForActiveTab('endereco', false);
            
            const numero = numeroInput.value.trim();
            const complemento = complementoInput.value.trim();
            
            let partes = [];
            
            if (activeData.enderecoBaseDetalhes.road) {
                partes.push(activeData.enderecoBaseDetalhes.road);
            }
            
            if (numero) {
                partes.push(numero);
            }

            if (complemento) {
                partes.push(complemento);
            }

            const partesEndBase = [
                activeData.enderecoBaseDetalhes.suburb || activeData.enderecoBaseDetalhes.neighbourhood,
                activeData.enderecoBaseDetalhes.city || activeData.enderecoBaseDetalhes.town || activeData.enderecoBaseDetalhes.village,
                activeData.enderecoBaseDetalhes.state
            ].filter(Boolean);

            partes = partes.concat(partesEndBase);

            enderecoInput.value = partes.filter(Boolean).join(', ').replace(/, ,/g, ',').replace(/,$/, '').trim();
            
            if (!activeData.enderecoBaseDetalhes.road && !numero && !complemento && partes.filter(Boolean).length === 0) {
                 enderecoInput.value = '';
            }
        }

        async function coletarGPS() {
            const activeData = getActiveData();
            const gpsDisplay = getElementByIdForActiveTab('gps');
            const mapPreview = document.getElementById('mapPreview'); // Map preview é compartilhado

            gpsDisplay.innerText = "Coletando localização...";
            mapPreview.style.display = 'none';
            activeData.mapImageUrl = ""; 

            if (!Maps_API_KEY || Maps_API_KEY === "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI") {
                alert("Por favor, configure sua CHAVE DE API DO GOOGLE MAPS no código para que o mapa funcione.");
                gpsDisplay.innerText = "Erro: API Key do Google não configurada.";
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lon = pos.coords.longitude.toFixed(6);
                    activeData.coordenadas = `Lat: ${lat}, Lng: ${lon}`;
                    gpsDisplay.innerText = activeData.coordenadas;

                    try {
                        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`;
                        const nominatimResponse = await fetch(nominatimUrl);
                        const nominatimData = await nominatimResponse.json();
                        activeData.enderecoBaseDetalhes = nominatimData.address || {};

                        atualizarEnderecoCompleto(activeTab === 'agenteCampo' ? 'agente' : 'tecnico');

                        const zoom = 15;
                        const size = "400x200"; 
                        const marker = `markers=color:red%7Clabel:P%7C${lat},${lon}`;
                        
                        activeData.mapImageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lon}&zoom=${zoom}&size=${size}&${marker}&key=${Maps_API_KEY}`;
                        
                        mapPreview.src = activeData.mapImageUrl;
                        mapPreview.style.display = 'block';

                    } catch (fetchError) {
                        console.error("Erro ao obter endereço ou mapa:", fetchError);
                        getElementByIdForActiveTab('endereco').value = "Não foi possível obter o endereço detalhado.";
                        activeData.enderecoBaseDetalhes = {};
                        mapPreview.style.display = 'none';
                        activeData.mapImageUrl = "";
                        alert("Erro ao carregar endereço ou mapa. Verifique a API Key do Google e a conexão.");
                    }
                }, (geoError) => {
                    console.error("Erro de geolocalização:", geoError);
                    let errorMessage = "Não foi possível obter a localização.";
                    if (geoError.code === geoError.PERMISSION_DENIED) {
                        errorMessage = "Permissão de localização negada. Ative nas configurações do navegador.";
                    } else if (geoError.code === geoError.POSITION_UNAVAILABLE) {
                        errorMessage = "Localização indisponível. Tente novamente.";
                    } else if (geoError.code === geoError.TIMEOUT) {
                        errorMessage = "Tempo esgotado para obter a localização.";
                    }
                    alert(errorMessage);
                    gpsDisplay.innerText = errorMessage;
                    activeData.enderecoBaseDetalhes = {};
                    mapPreview.style.display = 'none';
                    activeData.mapImageUrl = "";
                });
            } else {
                alert("Geolocalização não suportada neste navegador.");
                gpsDisplay.innerText = "Geolocalização não suportada.";
                activeData.enderecoBaseDetalhes = {};
                mapPreview.style.display = 'none';
                activeData.mapImageUrl = "";
            }
        }

        function resizeImage(base64Str, targetWidth = 600) { 
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let originalWidth = img.width;
                    let originalHeight = img.height;

                    let targetHeight = (targetWidth / 4) * 3; 

                    canvas.width = targetWidth;
                    canvas.height = targetHeight;

                    let ctx = canvas.getContext('2d');
                    ctx.fillStyle = "#FFFFFF"; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    let imgToDrawWidth, imgToDrawHeight, imgX, imgY;

                    if (originalWidth >= originalHeight) { 
                        let scale = targetWidth / originalWidth;
                        imgToDrawWidth = targetWidth;
                        imgToDrawHeight = originalHeight * scale;
                        imgX = 0;
                        imgY = (targetHeight - imgToDrawHeight) / 2; 
                    } else { 
                        let scale = targetHeight / originalHeight;
                        imgToDrawWidth = originalWidth * scale;
                        imgToDrawHeight = targetHeight;
                        imgX = (targetWidth - imgToDrawWidth) / 2; 
                        imgY = 0;
                    }
                    
                    ctx.drawImage(img, imgX, imgY, imgToDrawWidth, imgToDrawHeight);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                };
                img.onerror = () => {
                    console.warn("Falha ao carregar ou redimensionar imagem (Base64 inválido ou erro de rede).");
                    resolve(null);
                };
            });
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            addCustomFont(doc);

            const activeData = getActiveData();
            const currentTabSuffix = activeTab === 'agenteCampo' ? '' : '_tecnico';

            const nomeAgente = getElementByIdForActiveTab('nomeAgente').value.trim();
            const telefoneAgente = getElementByIdForActiveTab('telefoneAgente').value.trim();
            const nome = getElementByIdForActiveTab('nome').value.trim();
            const identidade = getElementByIdForActiveTab('identidade').value.trim(); 
            const cpf = getElementByIdForActiveTab('cpf').value.trim(); 
            const enderecoFinalParaPDF = getElementByIdForActiveTab('endereco').value || "Não informado"; 
            const idade = getElementByIdForActiveTab('idade').value || "Não informada";
            const nascimento = getElementByIdForActiveTab('dataNascimento').value || "Não informado";
            const historico = getElementByIdForActiveTab('historico').value || "Não informado";
            const codigo = activeData.codigoAtual || gerarCodigoAtendimento();

            // Desabilitar campos do agente/técnico após a primeira geração de PDF
            if (!activeData.agenteDadosPreenchidos && nomeAgente && telefoneAgente) {
                getElementByIdForActiveTab('nomeAgente').disabled = true;
                getElementByIdForActiveTab('telefoneAgente').disabled = true;
                activeData.agenteDadosPreenchidos = true;
            }

            if (!nomeAgente) {
                alert("Por favor, preencha o campo 'Nome do Agente/Técnico Responsável' para gerar o relatório.");
                return;
            }
            if (!telefoneAgente) {
                alert("Por favor, preencha o campo 'Telefone do Agente/Técnico Responsável' para gerar o relatório.");
                return;
            }
            if (!nome) { 
                alert("Por favor, preencha o campo 'Nome do Usuário' para gerar o relatório.");
                return;
            }

            const demandasSelecionadas = [];
            const demandaOutrosCheckbox = getElementByIdForActiveTab('demandaOutros');
            const outrosTextInput = getElementByIdForActiveTab('outrosDemandaInput');

            const checkboxes = document.querySelectorAll(`input[name="demandas${currentTabSuffix}"]:checked`);
            checkboxes.forEach(checkbox => {
                if (checkbox.value === 'Outros') {
                    const outrosText = outrosTextInput.value.trim();
                    if (outrosText) {
                        demandasSelecionadas.push(`Outros: ${outrosText}`);
                    }
                } else {
                    demandasSelecionadas.push(checkbox.value);
                }
            });

            if (demandaOutrosCheckbox.checked && outrosTextInput.value.trim() === '') {
                alert("Você marcou 'Outros' nas demandas. Por favor, especifique a demanda no campo de texto.");
                outrosTextInput.focus(); 
                return;
            }

            if (demandasSelecionadas.length === 0) {
                alert("Por favor, selecione pelo menos uma 'Demanda' ou preencha o campo 'Outros'.");
                return;
            }


            let yPos = 20;

            doc.setFontSize(18);
            doc.text(`Relatório de Usuário (${activeTab === 'agenteCampo' ? 'Agente de Campo' : 'Técnico'})`, 105, yPos, { align: 'center' });
            yPos += 15;

            doc.setFontSize(12);
            doc.text(`Relatório nº: ${codigo}`, 10, yPos);
            yPos += 10;
            doc.text(`Data e Hora: ${new Date().toLocaleString('pt-BR')}`, 10, yPos);
            yPos += 5;
            doc.text(`${activeTab === 'agenteCampo' ? 'Agente Responsável' : 'Técnico Responsável'}: ${nomeAgente} (Tel: ${telefoneAgente})`, 10, yPos);
            yPos += 10;

            doc.setFontSize(14);
            doc.text(`Dados Pessoais:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            doc.text(`Nome: ${nome}`, 10, yPos);
            yPos += 7;
            doc.text(`Identidade: ${identidade || "Não informada"}`, 10, yPos); 
            yPos += 7;
            doc.text(`CPF: ${cpf || "Não informado"}`, 10, yPos); 
            yPos += 7;
            doc.text(`Data de Nascimento: ${nascimento} (Idade: ${idade})`, 10, yPos);
            yPos += 7;
            doc.text(`Endereço: ${enderecoFinalParaPDF}`, 10, yPos); 
            yPos += 7;
            doc.text(`Coordenadas: ${activeData.coordenadas || "Não coletadas"}`, 10, yPos);
            yPos += 15;

            if (activeData.mapImageUrl && Maps_API_KEY && Maps_API_KEY !== "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI") {
                 try {
                    const response = await fetch(activeData.mapImageUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const blob = await response.blob();
                    const mapBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = () => {
                            console.error("FileReader failed to convert map blob to Base64.");
                            resolve(null);
                        };
                        reader.readAsDataURL(blob);
                    });

                    if (mapBase64) {
                        if (yPos + 80 > doc.internal.pageSize.height - 10) {
                            doc.addPage();
                            yPos = 20;
                            addCustomFont(doc);
                        }
                        doc.setFontSize(14);
                        doc.text(`Localização no Mapa:`, 10, yPos);
                        yPos += 8;
                        const mapWidth = 100;
                        const mapHeight = (mapWidth / 4) * 3; 
                        doc.addImage(mapBase64, 'PNG', 10, yPos, mapWidth, mapHeight); 
                        yPos += mapHeight + 10;
                    } else {
                         doc.text(`(Falha ao processar mapa para PDF - Base64 vazio)`, 10, yPos);
                         yPos += 10;
                    }
                } catch (mapImgError) {
                    console.error("Erro ao adicionar imagem do mapa ao PDF:", mapImgError);
                    doc.text(`(Erro ao carregar mapa para PDF)`, 10, yPos);
                    yPos += 10;
                }
            } else if (activeData.mapImageUrl && (!Maps_API_KEY || Maps_API_KEY === "SUA_CHAVE_DE_API_DO_GOOGLE_AQUI")) {
                doc.text(`(Mapa não incluído: Chave de API do Google ausente/inválida)`, 10, yPos);
                yPos += 10;
            }
            yPos += 5;

            doc.setFontSize(14);
            doc.text(`Histórico:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            let textoQuebrado = doc.splitTextToSize(historico, 180);
            doc.text(textoQuebrado, 10, yPos);
            yPos += textoQuebrado.length * 7 + 10;

            // Adicionar Demandas ao PDF
            doc.setFontSize(14);
            doc.text(`Demandas:`, 10, yPos);
            yPos += 8;
            doc.setFontSize(12);
            if (demandasSelecionadas.length > 0) {
                const demandasTexto = demandasSelecionadas.join(', ');
                let demandasQuebradas = doc.splitTextToSize(demandasTexto, 180);
                doc.text(demandasQuebradas, 10, yPos);
                yPos += demandasQuebradas.length * 7 + 10;
            } else {
                doc.text(`Nenhuma demanda selecionada.`, 10, yPos);
                yPos += 10;
            }
            yPos += 5; 

            doc.setFontSize(14);
            doc.text(`Fotos do Usuário:`, 10, yPos); 
            yPos += 8;
            doc.setFontSize(12);

            const imgWidthPdf = 60; 
            const imgHeightPdf = (imgWidthPdf / 4) * 3; 
            const imgMarginPdf = 5; 
            const startXPdf = 10; 
            let currentXPdf = startXPdf;
            let imagesInRowPdf = 0;

            for (let i = 0; i < activeData.fotos.length; i++) {
                if (imagesInRowPdf === 3 || (yPos + imgHeightPdf + 10 > doc.internal.pageSize.height - 10 && imagesInRowPdf > 0)) {
                    doc.addPage();
                    yPos = 20; 
                    currentXPdf = startXPdf; 
                    imagesInRowPdf = 0; 
                    addCustomFont(doc); 
                } else if (yPos + imgHeightPdf + 10 > doc.internal.pageSize.height - 10 && imagesInRowPdf === 0) {
                     doc.addPage();
                     yPos = 20;
                     currentXPdf = startXPdf;
                     imagesInRowPdf = 0;
                     addCustomFont(doc);
                }

                try {
                    const resizedFoto = await resizeImage(activeData.fotos[i], 800); 
                    if (resizedFoto) {
                        doc.addImage(resizedFoto, 'JPEG', currentXPdf, yPos, imgWidthPdf, imgHeightPdf);
                        currentXPdf += imgWidthPdf + imgMarginPdf; 
                        imagesInRowPdf++;

                        if (imagesInRowPdf === 3) { 
                            yPos += imgHeightPdf + imgMarginPdf;
                            currentXPdf = startXPdf;
                            imagesInRowPdf = 0;
                        }
                    } else {
                         console.warn(`Could not process photo ${i + 1} for PDF.`);
                    }
                } catch (imgError) {
                    console.error("Erro ao adicionar imagem ao PDF:", imgError);
                }
            }
            if (activeData.fotos.length === 0) {
                 doc.text("Nenhuma foto anexada.", 10, yPos);
                 yPos += 10;
            }

            activeData.pdfFileName = `relatorio-${codigo}.pdf`;
            activeData.pdfDataUri = doc.output('datauristring'); 

            doc.save(activeData.pdfFileName); // Salva o PDF no dispositivo do usuário

            document.getElementById('btnEnviarWhatsApp').disabled = false;
            
            // Chamada automática para enviar via WhatsApp
            enviarWhatsApp();
        }

        function limparFormulario() {
            const activeData = getActiveData();
            const currentTabSuffix = activeTab === 'agenteCampo' ? '' : '_tecnico';

            getElementByIdForActiveTab('nome').value = '';
            // CORREÇÃO AQUI: ERA getElementByIdForEricssonByIdForActiveTab
            getElementByIdForActiveTab('identidade').value = ''; 
            getElementByIdForActiveTab('cpf').value = ''; 
            getElementByIdForActiveTab('endereco').value = '';
            getElementByIdForActiveTab('numero').value = '';
            getElementByIdForActiveTab('complemento').value = '';
            getElementByIdForActiveTab('dataNascimento').value = '';
            getElementByIdForActiveTab('idade').value = '';
            getElementByIdForActiveTab('historico').value = '';
            getElementByIdForActiveTab('contador').innerText = '0 / 5000';
            getElementByIdForActiveTab('gps').innerText = '';
            
            activeData.fotos = [];
            getElementByIdForActiveTab('fotosPreview').innerHTML = '';

            pararCamera('global'); 

            activeData.coordenadas = "";
            activeData.enderecoBaseDetalhes = {};
            activeData.mapImageUrl = ""; 
            document.getElementById('mapPreview').src = "";
            document.getElementById('mapPreview').style.display = 'none';

            // Desmarca todos os checkboxes de demanda e limpa o campo "Outros"
            document.querySelectorAll(`input[name="demandas${currentTabSuffix}"]:checked`).forEach(checkbox => {
                checkbox.checked = false;
            });
            getElementByIdForActiveTab('outrosDemandaInput').value = '';
            getElementByIdForActiveTab('outrosDemandaContainer').style.display = 'none';

            document.getElementById('btnEnviarWhatsApp').disabled = true;
            activeData.pdfDataUri = null; 
            activeData.pdfFileName = ""; 

            // Re-habilita os campos do agente/técnico para a próxima entrada, se eles tiverem sido desabilitados
            getElementByIdForActiveTab('nomeAgente').disabled = false;
            getElementByIdForActiveTab('telefoneAgente').disabled = false;
            activeData.agenteDadosPreenchidos = false;

            gerarCodigoAtendimento();
        }

        async function enviarWhatsApp() {
            const activeData = getActiveData();

            if (!activeData.pdfDataUri || document.getElementById('btnEnviarWhatsApp').disabled) {
                alert("Nenhum relatório PDF foi gerado ou o botão está desabilitado.");
                return;
            }

            const mensagem = encodeURIComponent(`Relatório ${activeData.pdfFileName}, enviado automaticamente via sistema. Este relatório não poderá ser modificado e ficará a cargo do assistente social, para a sua revisão. Qualquer dúvida, entrar em contato com o agente relacionado.`);

            // Converte o Data URI do PDF em um Blob
            const byteCharacters = atob(activeData.pdfDataUri.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            const file = new File([blob], activeData.pdfFileName, { type: 'application/pdf' });

            // Tentar usar Web Share API para compartilhar o arquivo
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    // Tenta compartilhar, mas não podemos forçar apenas o WhatsApp aqui.
                    // O navegador abrirá a interface de compartilhamento do sistema.
                    await navigator.share({
                        files: [file],
                        title: activeData.pdfFileName,
                        text: decodeURIComponent(mensagem), 
                    });
                    console.log('Compartilhado com sucesso via Web Share API.');
                } catch (error) {
                    console.error('Erro ao compartilhar via Web Share API:', error);
                    // Se a API falhar ou o usuário cancelar, tentamos a abordagem de URL.
                    abrirWhatsAppComMensagem(mensagem, "Falha no compartilhamento direto. Tente anexar o PDF manualmente.");
                }
            } else {
                // Fallback: Tentar abrir o WhatsApp via URL.
                // A API do WhatsApp Web/App não permite anexar arquivos diretamente via URL de forma universal por segurança.
                // Será preciso orientar o usuário a anexar o arquivo.
                abrirWhatsAppComMensagem(mensagem, "Seu navegador não suporta o compartilhamento direto de arquivos. O WhatsApp será aberto com a mensagem pré-preenchida, por favor, anexe o PDF '"+ activeData.pdfFileName +"' manualmente.");
            }
        }

        function abrirWhatsAppComMensagem(mensagemCodificada, alertMessage) {
            // Tenta abrir o WhatsApp diretamente com a mensagem.
            // O anexo do PDF precisará ser feito manualmente pelo usuário no WhatsApp.
            const whatsappUrl = `https://wa.me/?text=${mensagemCodificada}`;
            window.open(whatsappUrl, '_blank');
            if (alertMessage) {
                alert(alertMessage);
            }
        }
    </script>
</body>
</html>